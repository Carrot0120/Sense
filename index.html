<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾ˆæœ‰SENSEå˜›~</title>
    <!-- ç§»é™¤å¤–éƒ¨æ¨¡çµ„é è¼‰ï¼Œæ”¹ç‚ºç¨‹å¼å…§å‹•æ…‹è¼‰å…¥ä»¥é¿å… Edge æœ¬æ©Ÿæª”æ¡ˆé™åˆ¶ -->
    <style>
        /* -------------------- è¦–è¦ºè¨­è¨ˆèˆ‡ RWD åŸºç¤ -------------------- */
        :root {
            /* é è¨­ä¸»é¡Œè‰² (æµªæ¼«ä¸»é¡Œ) */
            --main-color: #e91e63;
            --light-color: #ff80ab;
            --background-color: #fce4ec;
            --card-color: #fff8e1;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: var(--background-color); 
            color: #333;
            transition: background-color 0.8s ease; 
        }

        header {
            background: linear-gradient(135deg, var(--main-color), var(--light-color)); 
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin-bottom: 25px;
            transition: background-color 0.8s ease;
        }
        
        h1 { margin: 0; font-size: 2.2em; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        .tabs { display: flex; gap: 10px; margin: 0 0 15px; }
        .tab-btn { padding: 10px 14px; border: none; border-radius: 10px; background: #eceff1; color: #37474f; font-weight: 700; cursor: pointer; }
        .tab-btn.active { background: linear-gradient(90deg, var(--main-color), var(--light-color)); color: #fff; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 14px; margin-top: 12px; }
        .card { background: #fff; border: 1px solid #eee; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.08); overflow: hidden; }
        .card-img { width: 100%; height: 120px; object-fit: cover; display: block; }
        .card-map { width: 100%; height: 120px; display: block; border: 0; }
        .card-img-fallback { width: 100%; height: 120px; display: flex; align-items: center; justify-content: center; background: linear-gradient(90deg, var(--main-color), var(--light-color)); color: #fff; font-weight: 700; letter-spacing: 0.5px; }
        .card-body { padding: 10px 12px; }
        .card-title { font-weight: 800; color: #333; margin: 0 0 6px; }
        .card-tags { margin: 6px 0; }
        .card-actions { display: flex; gap: 8px; margin-top: 8px; }

        #planner-form { 
            background-color: #ffffff; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            margin-bottom: 30px; 
            border-top: 6px solid var(--light-color); 
            transition: border-top-color 0.8s ease;
        }
        
        /* è¡¨å–®ç¶²æ ¼ä½ˆå±€ */
        #input-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px 20px;
            margin-bottom: 20px;
        }

        /* è¼¸å…¥/é¸æ“‡æ¡†æ¨£å¼ */
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px; 
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 8px; 
            font-size: 1em;
            box-sizing: border-box;
        }
        input:focus, select:focus { border-color: var(--main-color); outline: none; box-shadow: 0 0 8px rgba(233, 30, 99, 0.5); }
        
        /* Key è¼¸å…¥å’Œç”ŸæˆæŒ‰éˆ•æ¨£å¼ */
        #key-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        #validate-btn { padding: 10px 15px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #generate-btn { 
            width: 100%;
            padding: 18px 20px; 
            background-color: var(--main-color); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background-color 0.8s ease;
        }
        #generate-btn:hover { background-color: #c2185b; }
        #generate-btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
        
        /* è¼¸å‡ºçµæœæ¨£å¼ */
        #itinerary-output { background-color: #ffffff; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); overflow-x: auto; }
        .day-plan { background-color: var(--card-color); border: 1px solid var(--light-color); margin-bottom: 30px; padding: 20px; border-radius: 12px; transition: background-color 0.8s ease, border-color 0.8s ease; }
        .day-plan h3 { color: var(--main-color); border-bottom: 3px solid var(--light-color); padding-bottom: 5px; margin-top: 0; transition: color 0.8s ease, border-bottom-color 0.8s ease; }
        
        /* AI æ—…ä¼´èªæ°£å°èª */
        #ai-greeting {
            background-color: #e0f7fa;
            color: #00796b;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 1.1em;
            font-style: italic;
            border-left: 5px solid #00bcd4;
        }

        /* è¡Œç¨‹æ°£æ°›åˆ†æ */
        #mood-analysis {
            margin-bottom: 25px;
            padding: 15px 20px;
            background-color: #f3e5f5;
            border-radius: 8px;
            font-weight: bold;
            border: 1px dashed #ce93d8;
        }
        #mood-analysis p { margin: 5px 0; }

        /* æƒ…ç·’å‚™è¨»æ¨£å¼ */
        .mood-note { 
            font-weight: bold; 
            color: #880e4f; 
            margin-top: 8px; 
            font-size: 0.95em; 
            padding: 6px 0;
            border-top: 1px dashed #f48fb1;
            white-space: normal;
        }

        /* æ–°å¢ï¼šæƒ…ç·’åé¥‹å€ (ä»£æ›¿æ—¥è¨˜æŒ‰éˆ•) */
        .feedback-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ccc;
            background-color: #fafafa;
            padding: 15px;
            border-radius: 8px;
        }
        .feedback-container label { font-weight: bold; margin-right: 10px; }
        .feedback-container input[type="text"] { 
            width: calc(100% - 140px); 
            display: inline-block;
            padding: 8px;
        }
        .feedback-container select { 
            width: 120px; 
            padding: 8px;
            display: inline-block;
        }
        .feedback-container div { margin-bottom: 10px; }

        /* æœ€çµ‚æƒ…ç·’ç¸½çµæŒ‰éˆ• */
        #analyze-mood-btn {
            width: 100%;
            padding: 15px;
            margin-top: 30px;
            background-color: #4db6ac; /* ç¶ æ¾çŸ³è‰² */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #analyze-mood-btn:hover { background-color: #26a69a; }
        #analyze-mood-btn:disabled { background-color: #ccc; cursor: not-allowed; }
        .next-day-btn {
            margin-top: 10px;
            padding: 10px 14px;
            background: linear-gradient(90deg, var(--main-color), var(--light-color));
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.12);
            transition: transform 0.1s ease, opacity 0.3s ease;
        }
        .next-day-btn:hover { transform: translateY(-1px); }
        .next-day-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .pressed { filter: brightness(0.95); transform: translateY(1px); }
        .btn-loading { opacity: 0.85; }
        .btn-done { box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.35) inset; }
        .chip {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            background-color: var(--light-color);
            color: #fff;
            font-size: 0.8em;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-right: 6px;
        }

        /* æœ€çµ‚æƒ…ç·’åˆ†æçµæœå€ */
        #final-mood-summary {
            margin-top: 20px;
            padding: 25px;
            background-color: #e8f5e9;
            border: 2px solid #aed581;
            border-radius: 10px;
            font-size: 1.1em;
            line-height: 1.6;
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
        }

        .summary { margin-top: 20px; padding: 15px; background-color: #f8bbd0; border-left: 5px solid var(--main-color); font-weight: bold; color: #880e4f; border-radius: 6px; }
        .final-cost { color: var(--main-color); margin-top: 30px; padding: 15px; border: 2px dashed var(--light-color); border-radius: 8px; text-align: center; }

        #assistant-toggle {
            position: fixed;
            right: 20px;
            bottom: 20px;
            z-index: 999;
            padding: 12px 16px;
            border-radius: 26px;
            background: linear-gradient(90deg, var(--main-color), var(--light-color));
            color: #fff;
            border: none;
            font-weight: 700;
            box-shadow: 0 8px 20px rgba(0,0,0,0.18);
            cursor: pointer;
        }
        #assistant-panel {
            position: fixed;
            right: 20px;
            bottom: 70px;
            width: 360px;
            max-height: 70vh;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 12px 28px rgba(0,0,0,0.22);
            overflow: hidden;
            display: none;
            z-index: 998;
            border: 1px solid #eee;
        }
        #assistant-panel.open { display: block; }
        .assistant-header {
            padding: 12px 14px;
            background: linear-gradient(135deg, var(--main-color), var(--light-color));
            color: #fff;
            font-weight: 700;
        }
        .assistant-body { padding: 12px 14px; }
        .assistant-body { max-height: 56vh; overflow-y: auto; }
        #assistant-results { max-height: 46vh; overflow-y: auto; }
        .assistant-search {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .assistant-search input {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .assistant-search button {
            padding: 8px 10px;
            border: none;
            border-radius: 8px;
            background: var(--main-color);
            color: #fff;
            font-weight: 700;
            cursor: pointer;
        }
        .faq-item {
            border: 1px solid #f0f0f0;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 10px;
            background: #fafafa;
        }
        .faq-item h4 { margin: 0 0 6px; color: #333; }
        .faq-tags { margin-top: 6px; }
        .faq-tags .chip { background: #eee; color: #555; }
        .assistant-answer {
            margin-top: 8px;
            padding: 10px;
            border-radius: 8px;
            background: #f9fbe7;
            border: 1px solid #e6ee9c;
            white-space: pre-wrap;
        }
        .tools-bar {
            margin: 12px 0 18px;
            display: none;
            gap: 10px;
        }
        .tools-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            background: #607d8b;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
        }
        .tools-btn:hover { opacity: 0.9; }
        button, .tools-btn, .next-day-btn { touch-action: manipulation; }
        /* è¡Œç¨‹è¡¨å„ªåŒ–å€å¡Š */
        .itinerary-table {
            width: 100%;
            border-collapse: collapse; /* ç§»é™¤è¡¨æ ¼çš„é‚Šç•Œé‡ç–Š */
            margin-top: 15px;
            table-layout: fixed; /* å›ºå®šåˆ—å¯¬ */
        }

        .itinerary-table th, .itinerary-table td {
            padding: 12px 8px; /* å¢åŠ å…§é‚Šè· */
            text-align: left;
            vertical-align: top;
            font-size: 0.95em;
        }

        .itinerary-table thead th {
            background-color: var(--light-color);
            color: white;
            font-weight: bold;
            border-bottom: 3px solid var(--main-color);
            position: sticky; /* è®“è¡¨é ­åœ¨æ»¾å‹•æ™‚å›ºå®š */
            top: 0;
        }
        
        /* å¢åŠ è¡Œç¨‹é …ç›®ä¹‹é–“çš„é–“éš”èˆ‡å€éš”ç·š */
        .itinerary-table tbody tr {
            /* é€™æ˜¯é—œéµçš„é–“éš”èˆ‡è¦–è¦ºå€éš” */
            border-bottom: 8px solid var(--card-color); /* æ¨¡æ“¬é–“è·çš„ç²—åº•ç·š */
            background-color: #ffffff; /* è®“é …ç›®åº•è‰²ç¨ç«‹æ–¼ day-plan */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* è¼•å¾®é™°å½±å¢åŠ ç«‹é«”æ„Ÿ */
        }
        
        /* ç¬¬ä¸€å±¤ tr æ˜¯è¡Œç¨‹å…§å®¹ï¼Œç¬¬äºŒå±¤ tr æ˜¯åœ°åœ–ï¼Œæˆ‘å€‘åªå°è¡Œç¨‹å…§å®¹ tr å¢åŠ é–“éš”ï¼Œä¸”å°‡åœ°åœ– tr çš„èƒŒæ™¯è¨­ç‚ºå’Œ day-plan ä¸€æ¨£ */
        .itinerary-table tbody tr:nth-child(even) { /* åœ°åœ–é‚£è¡Œï¼Œå–æ¶ˆç™½åº• */
            background-color: var(--card-color);
            border-bottom: 0;
            padding-bottom: 0;
            box-shadow: none;
        }
        
        /* ç§»é™¤æœ€å¾Œä¸€ç­†è¡Œç¨‹çš„åº•éƒ¨é–“éš”ï¼Œè®“å®ƒçœ‹èµ·ä¾†æ›´å®Œæ•´ */
        .itinerary-table tbody tr:last-child {
            border-bottom: none;
        }
        
        /* é¿å…åœ°åœ–ä¸Šæ–¹çš„ tr è¢«åº•ç·šæ“‹ä½ï¼Œä½†é€™è£¡çš„çµæ§‹æ˜¯ tr+trï¼Œæ‰€ä»¥åªå°ç¬¬ä¸€å€‹ tr åšé–“éš”å°±å¥½ */
        .itinerary-table tbody tr:nth-child(odd) td {
            border-bottom: 1px solid #eee; /* ç´°ç·»çš„åˆ†éš”ç·š */
        }


        .time-col { width: 80px; font-weight: bold; }
        .duration-col { width: 100px; font-size: 0.85em; }
        .transport-col { width: 80px; }
        .cost-col { width: 100px; font-weight: bold; color: var(--main-color); }
        .item-col { width: auto; } /* è®“é …ç›®ä½”ç”¨å‰©é¤˜ç©ºé–“ */

        .note-intro {
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
        }
        
        .image-btn {
            display: inline-block;
            margin-top: 5px;
            padding: 3px 8px;
            background-color: #ffe0b2;
            color: #e65100;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        /* åœ°åœ–æ¨£å¼ */
        .map-container {
            width: 100%;
            height: 250px;
            margin-top: 10px;
            overflow: hidden;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .map-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }


        /* RWD å„ªåŒ– */
        @media (max-width: 900px) {
            .itinerary-table, .table-wrapper {
                display: block;
                overflow-x: auto;
                white-space: nowrap; /* é˜²æ­¢å…§å®¹æ›è¡Œï¼Œè®“è¡¨æ ¼å¯ä»¥æ°´å¹³æ²å‹• */
            }
            .itinerary-table {
                 min-width: 700px; /* ç¢ºä¿åœ¨å°è¢å¹•ä¸Šè‡³å°‘æœ‰ä¸€å®šå¯¬åº¦ */
            }
        }
        
        @media (max-width: 600px) {
            .feedback-container input[type="text"], .feedback-container select {
                width: 100%;
                margin-top: 5px;
            }
            .feedback-container input[type="text"] { margin-left: 0; }
            .container { padding: 0 10px; }
            header { padding: 14px; }
            h1 { font-size: 1.6em; }
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .tab-btn { flex: 0 0 auto; }
            .cards-grid { grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); }
            .map-container { height: 180px; }
            #key-input-group { flex-wrap: wrap; }
            #key-input { width: 100%; }
            #validate-btn { width: 100%; margin-top: 8px; }
            .tools-bar { flex-wrap: wrap; }
            .tools-btn { flex: 1 1 140px; }
            .next-day-btn { width: 100%; }
            #assistant-panel { right: 3vw; bottom: 72px; width: 94vw; }
            .assistant-header { font-size: 0.95em; }
            .itinerary-table th, .itinerary-table td { font-size: 0.9em; }
        }
    </style>
</head>
<body>
    <audio id="mood-audio" loop></audio>

    <header>
        <h1>å¾ˆæœ‰SENSEå˜›~ğŸ’–AIæƒ…ç·’æ—…ä¼´è¦åŠƒ</h1>
    </header>
    
    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" data-page="page-planner">AI éŠç¨‹</button>
            <button class="tab-btn" data-page="page-wheel">éˆæ„Ÿè½‰ç›¤</button>
            <button class="tab-btn" data-page="page-playground">äº’å‹•å°ç©å…·</button>
            <button class="tab-btn" data-page="page-scheduler">æ’ç¨‹åŸ·è¡Œ</button>
            <button class="tab-btn" data-page="page-share">ç•™è¨€åˆ†äº«ç‰ˆ</button>
        </div>
        <div id="page-planner"><div id="planner-form">
            <div class="warning">
                **ğŸ”‘ Key æ³¨æ„ï¼šæ‚¨çš„ API Key æœƒåœ¨ç€è¦½å™¨ä¸­æš«å­˜ã€‚**
            </div>
            
            <label for="key-input" style="font-weight: bold;">Gemini API Keyï¼š</label>
            <div id="key-input-group">
                <input type="password" id="key-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„ Gemini API Key">
                <button id="validate-btn">é©—è­‰ Key</button>
            </div>
            <div id="key-status"></div>

            <div id="input-fields">
                <div>
                    <label for="destination">æ—…éŠåœ°å€ (åœ‹å®¶/åŸå¸‚)ï¼š</label>
                    <input type="text" id="destination" placeholder="ä¾‹å¦‚ï¼šéŸ“åœ‹é¦–çˆ¾" value="æ±äº¬">
                </div>
                <div>
                    <label for="duration">æ—…éŠå¤©æ•¸ï¼š</label>
                    <input type="number" id="duration" min="1" max="14" value="3">
                </div>
                <div>
                    <label for="travelers">åŒè¡Œäººæ•¸ï¼š</label>
                    <input type="number" id="travelers" min="1" max="10" value="2">
                </div>
                <div>
                    <label for="budget">é ç®—ç­‰ç´šï¼š</label>
                    <select id="budget">
                        <option value="ç¶“æ¿Ÿ">ç¶“æ¿Ÿ</option>
                        <option value="ä¸­ç­‰" selected>ä¸­ç­‰</option>
                        <option value="å¥¢è¯">å¥¢è¯</option>
                    </select>
                </div>
                <div>
                    <label for="transport">ä¸»è¦äº¤é€šæ–¹å¼ï¼š</label>
                    <select id="transport">
                        <option value="å¤§çœ¾é‹è¼¸" selected>å¤§çœ¾é‹è¼¸</option>
                        <option value="ç§Ÿè»Š">ç§Ÿè»Šè‡ªé§•</option>
                        <option value="è¨ˆç¨‹è»Š/æ­¥è¡Œ">è¨ˆç¨‹è»Š/æ­¥è¡Œ</option>
                    </select>
                </div>
                <div>
                    <label for="current_mood">ç¾åœ¨çš„å¿ƒæƒ…å¦‚ä½•ï¼Ÿ</label>
                    <select id="current_mood">
                        <option value="æœŸå¾…" selected>ğŸ˜€ æœŸå¾…/èˆˆå¥®</option>
                        <option value="å¹³éœ">ğŸ˜Œ å¹³éœ/ç™‚ç™’</option>
                        <option value="ç–²æ†Š">ğŸ˜´ ç–²æ†Š/éœ€è¦æ”¾é¬†</option>
                        <option value="æ¢ç´¢">ğŸ§ æ¢ç´¢/å¥½å¥‡</option>
                        <option value="å­¤å–®">ğŸ˜¥ å­¤å–®/æƒ³è¢«é™ªä¼´</option>
                        <option value="é–‹å¿ƒ">ğŸ˜„ å¿«æ¨‚/æ´»åŠ›</option>
                    </select>
                </div>
            </div>

            <label for="mood_theme" style="font-weight: bold;">æ—…éŠä¸»é¡Œ/æƒ…å¢ƒ (å€‹äººåŒ–æƒ…ç·’é—œéµ)ï¼š</label>
            <input type="text" id="mood_theme" placeholder="ä¾‹å¦‚ï¼šå°‹æ±‚ç™‚ç™’æ”¾é¬†ã€æµªæ¼«æƒ…ä¾¶ä¹‹æ—…ã€ç¨è‡ªæ¢éšªæŒ‘æˆ°" value="æƒ…ä¾¶æµªæ¼«æ”¾é¬†">
            
            <label for="interests" style="font-weight: bold; margin-top: 10px; display: block;">é¡å¤–éœ€æ±‚/ç‰¹æ®Šèˆˆè¶£ï¼š</label>
            <input type="text" id="interests" placeholder="ä¾‹å¦‚ï¼šä¸»æ‰“å‹•æ¼«æ™¯é»ã€å¸Œæœ›çœ‹å¤œæ™¯" value="å¸Œæœ›å®‰æ’ä¸€å¤©ä¸‹åˆåœ¨ç‰¹è‰²å’–å•¡å»³æ”¾ç©º">


            <button id="generate-btn" disabled>ğŸ’– ç‚ºæˆ‘ç”Ÿæˆå°ˆå±¬è¡Œç¨‹</button>
        </div>

        <div id="itinerary-output">
            <p>è«‹è¼¸å…¥æ‚¨çš„é‡‘é‘°ä¸¦é»æ“Šã€Œé©—è­‰ Keyã€ã€‚</p>
        </div>
        <div id="tools-bar" class="tools-bar">
            <button id="btn-export-ics" class="tools-btn">åŒ¯å‡ºè¡Œç¨‹ ICS</button>
            <button id="btn-export-json" class="tools-btn">å°å‡ºè¡Œç¨‹ JSON</button>
            <button id="btn-copy-text" class="tools-btn">è¤‡è£½è¡Œç¨‹æ–‡å­—</button>
            <button id="btn-print" class="tools-btn">åˆ—å°/å­˜æˆ PDF</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px; margin-top:6px;">
            <div>
                <label for="start_date_strategy">é–‹å§‹æ—¥æœŸç­–ç•¥ï¼š</label>
                <select id="start_date_strategy">
                    <option value="tomorrow" selected>èªªèµ°å°±èµ°ï¼ˆéš”å¤©ï¼‰</option>
                    <option value="random">éš¨æ©Ÿæ—¥æœŸ</option>
                    <option value="specific">æŒ‡å®šæ—¥æœŸ</option>
                </select>
            </div>
            <div>
                <label for="start_date_value">é–‹å§‹æ—¥æœŸï¼š</label>
                <input type="date" id="start_date_value">
            </div>
        </div>
        <div id="cards-section" class="day-plan" style="display:none;">
            <h3>ç›®çš„åœ°å¡ç‰‡</h3>
            <div id="destination-cards" class="cards-grid"></div>
        </div>
        
        <button id="analyze-mood-btn" style="display: none;">ğŸ’¡ é»æ“Šï¼šç¸½çµæˆ‘çš„æ—…ç¨‹æƒ…ç·’å›é¥‹</button>
        <div id="final-mood-summary"></div>
    </div>
        <div id="page-scheduler" style="display:none;">
            <div class="day-plan">
                <h3>æ’ç¨‹åŸ·è¡Œ</h3>
                <div class="summary">ç¢ºèªè¡Œç¨‹å¾Œï¼Œæ–¼æ­¤é€²è¡Œæ¯æ—¥å¾®èª¿èˆ‡åŸ·è¡Œã€‚</div>
                <div id="scheduler-output"></div>
            </div>
        </div>
        <div id="page-wheel" style="display:none;">
            <div class="day-plan">
                <h3>éˆæ„Ÿè½‰ç›¤</h3>
                <div style="display:flex; gap:12px; align-items:center;">
                    <select id="wheel-region">
                        <option value="å…¨çƒ">å…¨çƒ</option>
                        <option value="æ—¥æœ¬">æ—¥æœ¬</option>
                        <option value="éŸ“åœ‹">éŸ“åœ‹</option>
                        <option value="å°ç£">å°ç£</option>
                        <option value="æ­æ´²">æ­æ´²</option>
                    </select>
                    <button id="btn-spin" class="next-day-btn">ğŸ¡ è½‰ä¸€ä¸‹</button>
                </div>
                <div style="margin-top:10px;">
                    <div style="font-weight:700; margin-bottom:6px;">é¸æ“‡æ—…éŠä¸»é¡Œï¼ˆå¯å¤šé¸ï¼‰ï¼š</div>
                    <div id="wheel-themes-box" style="display:flex; gap:10px; flex-wrap:wrap;">
                        <label><input type="checkbox" class="wheel-theme" value="ä¼‘é–’åº¦å‡"> ä¼‘é–’åº¦å‡</label>
                        <label><input type="checkbox" class="wheel-theme" value="æ–‡åŒ–æ¢ç´¢"> æ–‡åŒ–æ¢ç´¢</label>
                        <label><input type="checkbox" class="wheel-theme" value="ç¥ç§˜éšªå†’"> ç¥ç§˜éšªå†’</label>
                        <label><input type="checkbox" class="wheel-theme" value="æ”¾é¬†ç™‚è‚²"> æ”¾é¬†ç™‚è‚²</label>
                        <label><input type="checkbox" class="wheel-theme" value="ç¾é£Ÿ/è€é¥•ä¹‹æ—…"> ç¾é£Ÿ/è€é¥•ä¹‹æ—…</label>
                        <label><input type="checkbox" class="wheel-theme" value="å¥åº·/é¤Šç”Ÿä¹‹æ—…"> å¥åº·/é¤Šç”Ÿä¹‹æ—…</label>
                        <label><input type="checkbox" class="wheel-theme" value="å­¸ç¿’/è€ƒå¯Ÿ"> å­¸ç¿’/è€ƒå¯Ÿ</label>
                        <label><input type="checkbox" class="wheel-theme" value="é‹å‹•æ—…éŠ"> é‹å‹•æ—…éŠ</label>
                    </div>
                </div>
                <div id="wheel-result" class="summary" style="margin-top:12px;">å˜—è©¦è½‰å‹•ä¾†ç²å¾—æ—…éŠéˆæ„Ÿï¼</div>
                <div style="margin-top:8px;">
                    <button id="wheel-apply" class="tools-btn" disabled>âœ¨ å¥—ç”¨åˆ°æ—…éŠåœ°å€</button>
                </div>
                <div id="wheel-list" style="margin-top:10px;"></div>
            </div>
        </div>
        <div id="page-playground" style="display:none;">
            <div class="day-plan">
                <h3>äº’å‹•å°ç©å…·</h3>
                <div style="display:flex; gap:12px; align-items:center;">
                    <button id="btn-idea" class="next-day-btn">ğŸ² é»å­éª°å­</button>
                    <div id="idea-result" class="summary" style="margin:0;">æŒ‰ä¸‹éª°å­ç²å¾—æ´»å‹•éˆæ„Ÿ</div>
                </div>
                <div style="margin-top:12px;">
                    <button id="btn-mood-boost" class="next-day-btn">ğŸ’« æ°›åœåŠ æˆ</button>
                    <div id="mood-boost-result" class="summary" style="margin-top:8px;">ç‚ºä½ çš„ä»Šæ—¥è¡Œç¨‹å¢åŠ ä¸€é»æƒ…ç·’æ°›åœ</div>
                </div>
            </div>
            <div class="day-plan">
                <h3>æƒ…ç·’å„€è¡¨</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div>
                        <label>æµªæ¼«</label>
                        <input type="range" id="meter-romance" min="0" max="100" value="60">
                    </div>
                    <div>
                        <label>ç™‚ç™’</label>
                        <input type="range" id="meter-heal" min="0" max="100" value="50">
                    </div>
                    <div>
                        <label>æ¢ç´¢</label>
                        <input type="range" id="meter-explore" min="0" max="100" value="40">
                    </div>
                    <div style="display:flex; align-items:center;">
                        <button id="btn-apply-meter" class="next-day-btn">ğŸ¨ å¥—ç”¨æƒ…ç·’ä¸»é¡Œ</button>
                    </div>
                </div>
                <div id="meter-advice" class="summary" style="margin-top:8px;"></div>
            </div>
            <div class="day-plan">
                <h3>æƒ…ç·’é…æ¨‚</h3>
                <div style="display:flex; gap:12px; align-items:center;">
                    <select id="playlist-mood">
                        <option value="æµªæ¼«" selected>æµªæ¼«</option>
                        <option value="æ”¾é¬†">æ”¾é¬†</option>
                        <option value="æ¢ç´¢">æ¢ç´¢</option>
                    </select>
                    <button id="btn-playlist" class="next-day-btn">â–¶ï¸ æ’­æ”¾</button>
                    <a id="playlist-link" class="tools-btn" target="_blank">åœ¨ YouTube æ‰“é–‹</a>
                </div>
                <div id="playlist-status" class="summary" style="margin-top:8px;">é¸æ“‡é…æ¨‚è®“å¿ƒæƒ…æ›´æœ‰æ°›åœ</div>
            </div>
        </div>
        <div id="page-share" style="display:none;">
            <div class="day-plan">
                <h3>ç•™è¨€åˆ†äº«ç‰ˆ</h3>
                <div class="summary">ä¸Šå‚³ä½ å®Œæˆè¡Œç¨‹çš„ç…§ç‰‡èˆ‡æ„Ÿå—ï¼Œçµ¦ä»–äººåƒè€ƒã€‚</div>
                <div id="share-form" style="display:grid; grid-template-columns: 1fr; gap:10px; margin-top:10px;">
                    <input id="share-title" type="text" placeholder="æ¨™é¡Œ">
                    <input id="share-location" type="text" placeholder="åœ°é»">
                    <textarea id="share-text" placeholder="ä½ çš„å¿ƒå¾—" rows="3"></textarea>
                    <input id="share-photo" type="file" accept="image/*">
                    <button id="share-submit" class="next-day-btn">ğŸ“¤ ä¸Šå‚³</button>
                </div>
                <div id="share-posts" class="cards-grid" style="margin-top:12px;"></div>
            </div>
        </div>

    <button id="assistant-toggle">â“ å°å¹«æ‰‹</button>
    <div id="assistant-panel">
        <div class="assistant-header">å°å¹«æ‰‹ãƒ»FAQ èˆ‡æ™ºèƒ½å•ç­”</div>
        <div class="assistant-body">
            <div class="assistant-search">
                <input id="assistant-input" type="text" placeholder="è¼¸å…¥é—œéµå­—æˆ–æå•ï¼Œä¾‹å¦‚ï¼šç‚ºä»€éº¼æŒ‰éˆ•ä¸èƒ½æŒ‰ï¼Ÿ">
                <button id="assistant-ask">å•æˆ‘</button>
            </div>
            <div id="assistant-results"></div>
            <div id="assistant-ai-answer" class="assistant-answer" style="display:none;"></div>
        </div>
    </div>

    <script>
        
        let isKeyValid = false; 
        let validatedApiKey = '';
        let userDiaryLogs = [];
        let aiClient; 
        let GoogleGenAICtor = null;
        let CURRENT_MODEL = 'gemini-2.5-flash';
        let sharedPosts = [];
        function saveDiaryForDay(di, parentEl) {
            if (isNaN(di)) return;
            const moodSelect = document.querySelector(`.day-mood-select[data-day-index="${di}"]`);
            const sentenceInput = document.querySelector(`.day-sentence-input[data-day-index="${di}"]`);
            const selectedMood = moodSelect ? moodSelect.value : '';
            const inputSentence = sentenceInput ? sentenceInput.value.trim() : '';
            const existing = userDiaryLogs.find(x => x.dayIndex === di);
            const payload = { dayIndex: di, mood: selectedMood, sentence: inputSentence, savedAt: Date.now() };
            if (existing) {
                existing.mood = payload.mood;
                existing.sentence = payload.sentence;
                existing.savedAt = payload.savedAt;
            } else {
                userDiaryLogs.push(payload);
            }
            const toastParent = parentEl || document.getElementById('scheduler-output') || document.getElementById('itinerary-output');
            if (toastParent) {
                const toast = document.createElement('div');
                toast.className = 'summary';
                toast.textContent = 'âœ… å·²å„²å­˜ä»Šæ—¥æ—¥è¨˜';
                toastParent.appendChild(toast);
                setTimeout(()=>{ try { toastParent.removeChild(toast); } catch {} }, 1200);
            }
        }
        async function loadGenAI() {
            if (GoogleGenAICtor) return GoogleGenAICtor;
            try {
                const mod = await import('https://esm.run/@google/genai');
                GoogleGenAICtor = mod.GoogleGenAI;
            } catch (e) {
                GoogleGenAICtor = null;
            }
            return GoogleGenAICtor;
        }
        let fullItineraryData = null; // å„²å­˜å®Œæ•´çš„è¡Œç¨‹æ•¸æ“šï¼Œä»¥ä¾¿æœ€çµ‚åˆ†æä½¿ç”¨
        let visitedLocations = new Set();
        let visitedDescriptions = new Set();
        function normalizeText(s) { return (s || '').trim().toLowerCase(); }
        function collectVisited(items) {
            items.forEach(it => {
                visitedLocations.add(normalizeText(it.location));
                visitedDescriptions.add(normalizeText(`${it.type}-${it.description}`));
            });
        }
        function hasDuplicates(items) {
            return items.some(it => visitedLocations.has(normalizeText(it.location)) || visitedDescriptions.has(normalizeText(`${it.type}-${it.description}`)));
        }
        
        // JSON Schema ä¿æŒä¸è®Š (å› ç‚ºåªéœ€è¦æå–æ•¸æ“š)
        const ITINERARY_SCHEMA = {
            type: "object",
            properties: {
                greeting: { type: "string" },
                mood_analysis: { type: "object", properties: { relax: { type: "string" }, romantic: { type: "string" }, explore: { type: "string" } } },
                days: {
                    type: "array",
                    items: {
                        type: "object",
                        properties: {
                            day: { type: "string" },
                            date: { type: "string" },
                            items: {
                                type: "array",
                                items: {
                                    type: "object",
                                    properties: {
                                        time: { type: "string" },
                                        description: { type: "string" },
                                        intro: { type: "string" }, 
                                        mood_note: { type: "string" },
                                        type: { type: "string", enum: ["æ™¯é»", "é¤é£Ÿ", "ä½å®¿", "æ´»å‹•"] },
                                        location: { type: "string" }, 
                                        transport: { type: "string" },
                                        duration_activity: { type: "string" },
                                        duration_travel: { type: "string" },
                                        cost: { type: "integer" }
                                    },
                                    required: ["time", "description", "intro", "mood_note", "type", "location", "transport", "duration_activity", "duration_travel", "cost"]
                                }
                            }
                        },
                        required: ["day", "date", "items"]
                    }
                }
            },
            required: ["greeting", "mood_analysis", "days"]
        };
        const DAY_SCHEMA = {
            type: "object",
            properties: {
                day: { type: "string" },
                date: { type: "string" },
                items: {
                    type: "array",
                    items: {
                        type: "object",
                        properties: {
                            time: { type: "string" },
                            description: { type: "string" },
                            intro: { type: "string" },
                            mood_note: { type: "string" },
                            type: { type: "string", enum: ["æ™¯é»", "é¤é£Ÿ", "ä½å®¿", "æ´»å‹•"] },
                            location: { type: "string" },
                            transport: { type: "string" },
                            duration_activity: { type: "string" },
                            duration_travel: { type: "string" },
                            cost: { type: "integer" }
                        },
                        required: ["time", "description", "intro", "mood_note", "type", "location", "transport", "duration_activity", "duration_travel", "cost"]
                    }
                }
            },
            required: ["day", "date", "items"]
        };

        // æƒ…ç·’ä¸»é¡Œé…ç½®
        const MOOD_CONFIG = {
            'æµªæ¼«': { main_color: '#e91e63', light_color: '#ff80ab', background_color: '#fce4ec', card_color: '#fff8e1', audio_url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
            'æ”¾é¬†': { main_color: '#388e3c', light_color: '#aed581', background_color: '#f1f8e9', card_color: '#e8f5e9', audio_url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
            'æ¢ç´¢': { main_color: '#1a237e', light_color: '#7986cb', background_color: '#e8eaf6', card_color: '#e3f2fd', audio_url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' },
            'default': { main_color: '#4CAF50', light_color: '#81c784', background_color: '#e8f5e9', card_color: '#f7fff7', audio_url: '' }
        };

        const MOOD_OPTIONS = [
            { value: "é–‹å¿ƒ", label: "ğŸ˜„ é–‹å¿ƒ" },
            { value: "ç™‚ç™’", label: "ğŸ˜Œ ç™‚ç™’" },
            { value: "ç–²æ†Š", label: "ğŸ˜´ ç–²æ†Š" },
            { value: "æ¢ç´¢", label: "ğŸ§ æ¢ç´¢" },
            { value: "æµªæ¼«", label: "ğŸ’ æµªæ¼«" },
            { value: "èˆˆå¥®", label: "ğŸ¤© èˆˆå¥®" },
            { value: "å­¤å–®", label: "ğŸ˜¥ å­¤å–®" },
            { value: "å¹³éœ", label: "ğŸ§˜ å¹³éœ" }
        ];

        function applyMoodTheme(moodTheme) {
            const themeKey = Object.keys(MOOD_CONFIG).find(key => moodTheme.includes(key)) || 'default';
            const config = MOOD_CONFIG[themeKey];
            const root = document.documentElement.style;
            const audio = document.getElementById('mood-audio');
            
            root.setProperty('--main-color', config.main_color);
            root.setProperty('--light-color', config.light_color);
            root.setProperty('--background-color', config.background_color);
            root.setProperty('--card-color', config.card_color);
            
            if (config.audio_url) {
                audio.src = config.audio_url;
                audio.volume = 0.3; 
                audio.play().catch(e => console.log("Audio playback blocked:", e)); 
            } else {
                audio.pause();
                audio.src = '';
            }
        }

        function setButtonState(btnId, isLoading, text) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            btn.textContent = text;
            btn.disabled = isLoading;
            
            if (btnId === 'generate-btn' && !isLoading) {
                btn.disabled = !isKeyValid;
            }
        }
        
        async function validateKey() {
            const geminiApiKey = document.getElementById('key-input').value.trim();
            
            const keyStatusDiv = document.getElementById('key-status');
            const generateBtn = document.getElementById('generate-btn');
            
            if (!geminiApiKey) {
                keyStatusDiv.innerHTML = `<span style="color:red;">è«‹è¼¸å…¥é‡‘é‘°ã€‚</span>`;
                isKeyValid = false;
                generateBtn.disabled = true;
                return;
            }

            if (!navigator.onLine) {
                keyStatusDiv.innerHTML = `<span style="color:red;">ç›®å‰è™•æ–¼é›¢ç·šç‹€æ…‹ï¼Œè«‹é€£ç·šå¾Œå†è©¦ã€‚</span>`;
                isKeyValid = false;
                generateBtn.disabled = true;
                return;
            }

            setButtonState('validate-btn', true, 'é©—è­‰ä¸­...');
            keyStatusDiv.innerHTML = `<span style="color:#007bff;">æ­£åœ¨é€£æ¥ API...</span>`;
            
            try {
                const GenAI = await loadGenAI();
                if (!GenAI) throw new Error('ç„¡æ³•è¼‰å…¥ AI æ¨¡çµ„ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ç¨å¾Œé‡è©¦ã€‚');
                aiClient = new GenAI({ apiKey: geminiApiKey }); 
                await aiClient.models.generateContent({
                    model: CURRENT_MODEL,
                    contents: 'Hello.', 
                    config: { maxOutputTokens: 1 } 
                });
                
                keyStatusDiv.innerHTML = `<span style="color:green; font-weight:bold;">âœ… Key é©—è­‰æˆåŠŸï¼</span>`;
                isKeyValid = true;
                validatedApiKey = geminiApiKey;
                generateBtn.disabled = false; 
                
            } catch (error) {
                console.error("Key é©—è­‰å¤±æ•—:", error);
                const msg = String(error.message || '');
                let display = '';
                if (/401|Unauthorized/i.test(msg)) {
                    display = "é‡‘é‘°ç„¡æ•ˆ (401 Unauthorized)ã€‚";
                } else if (/429|RESOURCE_EXHAUSTED|rate|quota/i.test(msg)) {
                    display = "å·²é”æ­¤æ¨¡å‹çš„é™é¡ (429)ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                } else if (/UNAVAILABLE|overloaded/i.test(msg)) {
                    display = "ç³»çµ±å¿™ç¢Œï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
                } else {
                    display = `é€£ç·šå¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯: ${msg.substring(0, 80)}â€¦`;
                }
                keyStatusDiv.innerHTML = `<span style="color:red;">âŒ Key é©—è­‰å¤±æ•—ã€‚åŸå› : ${display}</span>`;
                isKeyValid = false;
                generateBtn.disabled = true; 
            } finally {
                setButtonState('validate-btn', false, 'é©—è­‰ Key');
            }
        }
        
        const FAQ_DATA = [
            { q: "ç‚ºä»€éº¼æŒ‰éˆ•ä¸èƒ½æŒ‰ï¼Ÿ", a: "è«‹å…ˆé©—è­‰ Keyï¼Œä¸¦ç¢ºèªç¶²è·¯é€£ç·šæ­£å¸¸ã€‚é©—è­‰æˆåŠŸå¾ŒæŒ‰éˆ•æœƒå•Ÿç”¨ã€‚", tags: ["Key","é€£ç·š","ä½¿ç”¨æ–¹æ³•"] },
            { q: "ç”Ÿæˆè¡Œç¨‹å¤±æ•—æ€éº¼è¾¦ï¼Ÿ", a: "å¸¸è¦‹åŸå› ç‚ºé™é¡ 429 æˆ–ç³»çµ±å¿™ç¢Œã€‚è«‹ç¨å¾Œå†è©¦æˆ–ç°¡åŒ–éœ€æ±‚ã€‚", tags: ["ç”Ÿæˆ","éŒ¯èª¤","429"] },
            { q: "å¦‚ä½•é¿å…é‡è¤‡æ™¯é»ï¼Ÿ", a: "ç³»çµ±æœƒè¨˜éŒ„å·²è¨ªåœ°é»èˆ‡é …ç›®ï¼Œåœ¨ç”Ÿæˆä¸‹ä¸€å¤©æ™‚è‡ªå‹•é¿é–‹é‡è¤‡ã€‚", tags: ["é‡è¤‡","è¡Œç¨‹"] },
            { q: "å¦‚ä½•åšæƒ…ç·’ç¸½çµï¼Ÿ", a: "å®Œæˆè‡³å°‘å…©å¤©è¡Œç¨‹å¾Œï¼Œé»æ“Šé é¢ä¸‹æ–¹çš„åˆ†ææŒ‰éˆ•å³å¯ç”Ÿæˆæƒ…ç·’ç¸½çµèˆ‡åå¥½ã€‚", tags: ["æƒ…ç·’","åˆ†æ"] },
            { q: "æˆ‘çš„é‡‘é‘°å®‰å…¨å—ï¼Ÿ", a: "é‡‘é‘°åƒ…åœ¨ç€è¦½å™¨ä¸­ä½¿ç”¨ï¼Œä¸æœƒä¸Šå‚³åˆ°ä¼ºæœå™¨ã€‚è«‹å‹¿åˆ†äº«ã€‚", tags: ["é‡‘é‘°","å®‰å…¨","éš±ç§"] },
            { q: "è²»ç”¨ä¼°è¨ˆæ˜¯å¦æº–ç¢ºï¼Ÿ", a: "è²»ç”¨ç‚ºåƒè€ƒå€¼ï¼Œä¾åœ°é»èˆ‡å­£ç¯€æœ‰å·®ç•°ï¼Œè«‹ä»¥å¯¦éš›ç‚ºæº–ã€‚", tags: ["è²»ç”¨","ä¼°è¨ˆ"] },
            { q: "å¯ä»¥åªç”Ÿæˆä¸€å¤©å—ï¼Ÿ", a: "å¯ä»¥ã€‚å…ˆç”Ÿæˆç¬¬ä¸€å¤©ï¼Œå¡«å¯«å¿ƒæƒ…èˆ‡æ—¥è¨˜ï¼Œå†ç”Ÿæˆç¬¬äºŒå¤©ä»¥å‘¼æ‡‰æƒ…ç·’ã€‚", tags: ["ä¸€å¤©","ç¬¬äºŒå¤©"] },
            { q: "ç‚ºä½•é¡¯ç¤ºé›¢ç·šï¼Ÿ", a: "ç€è¦½å™¨åµæ¸¬åˆ°æœªé€£ç·šã€‚è«‹æª¢æŸ¥ç¶²è·¯æˆ–é—œé–‰é£›èˆªæ¨¡å¼å¾Œé‡è©¦ã€‚", tags: ["é›¢ç·š","é€£ç·š"] }
        ];
        function renderFAQ(list) {
            const box = document.getElementById('assistant-results');
            box.innerHTML = list.map(item => `
                <div class="faq-item">
                    <h4>${item.q}</h4>
                    <div>${item.a}</div>
                    <div class="faq-tags">${item.tags.map(t => `<span class="chip">${t}</span>`).join(' ')}</div>
                </div>
            `).join('');
        }
        function filterFAQ(q) {
            const t = (q || '').toLowerCase();
            return FAQ_DATA.filter(item => item.q.toLowerCase().includes(t) || item.a.toLowerCase().includes(t) || item.tags.some(tag => tag.toLowerCase().includes(t)));
        }
        async function askAssistant(query) {
            const ansBox = document.getElementById('assistant-ai-answer');
            ansBox.style.display = 'block';
            ansBox.textContent = 'æ€è€ƒä¸­...';
            const localBest = filterFAQ(query)[0];
            if (!isKeyValid || !aiClient) {
                ansBox.textContent = localBest ? localBest.a : 'ç›®å‰ç„¡æ³•ä½¿ç”¨ AIï¼Œè«‹å…ˆé©—è­‰ Key æˆ–ç¨å¾Œå†è©¦ã€‚';
                return;
            }
            try {
                const prompt = `é‡å°ä»¥ä¸‹ä½¿ç”¨è€…å•é¡Œï¼Œå›ç­”ç°¡æ½”ä¸”æœ‰æ“ä½œæ€§ï¼š\nå•é¡Œï¼šã€Œ${query}ã€`;
                const res = await aiClient.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                    config: { temperature: 0.3 }
                });
                ansBox.textContent = (res.text || '').trim() || (localBest ? localBest.a : 'æš«ç„¡ç­”æ¡ˆ');
            } catch (e) {
                ansBox.textContent = localBest ? localBest.a : 'AI å›è¦†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
            }
        }
        
        const WHEEL_POOL = {
            'å…¨çƒ': ['æ±äº¬','é¦–çˆ¾','å°åŒ—','æ›¼è°·','æ–°åŠ å¡','å·´é»','å€«æ•¦','é›ªæ¢¨','æ´›æ‰ç£¯','å·´å¡éš†ç´','ç±³è˜­','æŸæ—'],
            'æ—¥æœ¬': ['æ±äº¬','äº¬éƒ½','å¤§é˜ª','ç¦å²¡','æœ­å¹Œ','åå¤å±‹','æ²–ç¹©','é‡‘æ¾¤','ç¥æˆ¶','æ©«æ¿±'],
            'éŸ“åœ‹': ['é¦–çˆ¾','é‡œå±±','æ¿Ÿå·','å¤§é‚±','å…¨å·','ä»å·'],
            'å°ç£': ['å°åŒ—','æ–°åŒ—','æ¡ƒåœ’','æ–°ç«¹','å°ä¸­','å˜‰ç¾©','å°å—','é«˜é›„','å®œè˜­','èŠ±è“®','å°æ±'],
            'æ­æ´²': ['å·´é»','å€«æ•¦','å·´å¡éš†ç´','ç±³è˜­','ç¾…é¦¬','é˜¿å§†æ–¯ç‰¹ä¸¹','æŸæ—','ç¶­ä¹Ÿç´','å¸ƒæ‹‰æ ¼']
        };
        const THEME_SUGGESTIONS = {
            'ä¼‘é–’åº¦å‡': [
                { region: 'æ²–ç¹©', reason: 'æµ·å³¶æ…¢æ´»èˆ‡åº¦å‡é£¯åº—é¸æ“‡å¤š' },
                { region: 'å³‡é‡Œå³¶', reason: 'villa æ³³æ± èˆ‡ç™‚ç™’ SPA' },
                { region: 'æ¿Ÿå·å³¶', reason: 'ç«å±±æµ·å²¸ç·šèˆ‡å’–å•¡é¤¨å·¡ç¦®' },
                { region: 'æ¸…é‚', reason: 'æ­¥èª¿æ‚ ç·©èˆ‡æ£®æ—ç³»åº¦å‡' },
                { region: 'å¤å¨å¤·', reason: 'é™½å…‰æ²™ç˜èˆ‡è‡ªç„¶æ­¥é“' },
                { region: 'æœ­å¹Œè¿‘éƒŠ', reason: 'æ¹–æ³Šé¢¨å…‰èˆ‡å°é®æ¼«éŠ' }
            ],
            'æ–‡åŒ–æ¢ç´¢': [
                { region: 'äº¬éƒ½', reason: 'ç¥ç¤¾å¯ºé™¢èˆ‡ç”ºå®¶æ–‡åŒ–' },
                { region: 'ç¾…é¦¬', reason: 'å¤è¹Ÿå¯†é›†èˆ‡åŸå¸‚è€ƒå¤' },
                { region: 'å·´é»', reason: 'åšç‰©é¤¨è—å»Šèˆ‡æ­·å²è¡—æ™¯' },
                { region: 'å°å—', reason: 'å¤åŸå··å¼„èˆ‡åœ¨åœ°å»Ÿå®‡' },
                { region: 'åŒ—äº¬', reason: 'çš‡åŸè»¸ç·šèˆ‡çš‡å®¶åœ’æ—' },
                { region: 'ä¼Šæ–¯å¦å ¡', reason: 'æ–‡æ˜äº¤åŒ¯çš„å¤åŸé¢¨è²Œ' }
            ],
            'ç¥ç§˜éšªå†’': [
                { region: 'å†°å³¶', reason: 'å†°åŸã€ç«å±±èˆ‡æ¥µå…‰è¿½é€' },
                { region: 'æ–°è¥¿è˜­å—å³¶', reason: 'é«˜å±±å³½ç£èˆ‡éœ²ç‡Ÿå¥è¡Œ' },
                { region: 'ç§˜é­¯', reason: 'é¦¬ä¸˜æ¯”ä¸˜èˆ‡å®‰åœ°æ–¯å±±ç¾¤' },
                { region: 'æ‘©æ´›å“¥', reason: 'æ’’å“ˆæ‹‰é‚Šç·£èˆ‡é›†å¸‚æ¢ç´¢' },
                { region: 'å°¼æ³Šçˆ¾', reason: 'å–œé¦¬æ‹‰é›…å±±éº“ç™»å±±è·¯ç·š' },
                { region: 'å·´å¡”å“¥å°¼äº', reason: 'é™é è’é‡èˆ‡å†°å·å¥‡æ™¯' }
            ],
            'æ”¾é¬†ç™‚è‚²': [
                { region: 'ç®±æ ¹', reason: 'æº«æ³‰ç™‚ç™’èˆ‡ç¾è¡“é¤¨æ•£ç­–' },
                { region: 'åˆ¥åºœ', reason: 'åœ°ç„æº«æ³‰èˆ‡æ…¢æ´»æ­¥èª¿' },
                { region: 'èŠ±è“®', reason: 'æµ·å²¸å±±è„ˆä¹‹é–“çš„è‡ªç„¶èƒ½é‡' },
                { region: 'è”šå±±è¿‘éƒŠ', reason: 'æµ·é‚Šæ•£æ­¥èˆ‡å’–å•¡ç™‚ç™’' },
                { region: 'æ¿Ÿå·å³¶', reason: 'æµ·é¢¨æ­¥é“èˆ‡èŒ¶åœ’æ”¾é¬†' },
                { region: 'å³‡é‡Œå³¶', reason: 'ç‘œä¼½ SPA èˆ‡èº«å¿ƒä¿®å¾©' }
            ],
            'ç¾é£Ÿ/è€é¥•ä¹‹æ—…': [
                { region: 'å¤§é˜ª', reason: 'ç²‰ç‰©æ–‡åŒ–èˆ‡é“é “å €ç¾é£Ÿ' },
                { region: 'å°åŒ—', reason: 'å¤œå¸‚å°åƒèˆ‡ç±³å…¶æ—è¡—é ­' },
                { region: 'é¦–çˆ¾', reason: 'çƒ¤è‚‰ã€è¡—é‚Šæ–™ç†èˆ‡å’–å•¡' },
                { region: 'æ›¼è°·', reason: 'æ³°å¼è¡—é‚Šèˆ‡å¸‚å ´é¤é£²' },
                { region: 'é¦™æ¸¯', reason: 'èŒ¶é¤å»³èˆ‡ç²µå¼é»å¿ƒ' },
                { region: 'å°å—', reason: 'åœ¨åœ°å°åƒèˆ‡å‚³çµ±æ»‹å‘³' }
            ],
            'å¥åº·/é¤Šç”Ÿä¹‹æ—…': [
                { region: 'æ¸…é‚', reason: 'å¥åº·æ–™ç†èˆ‡éœå¿ƒèª²ç¨‹' },
                { region: 'å³‡é‡Œå³¶', reason: 'ç‘œä¼½éœä¿®èˆ‡è‡ªç„¶é£²é£Ÿ' },
                { region: 'éœå²¡', reason: 'ç¶ èŒ¶æ–‡åŒ–èˆ‡æ­¥é“å¥è¡Œ' },
                { region: 'è‹—æ —', reason: 'å±±æ—æ­¥é“èˆ‡æ…¢åŸé¢¨æ ¼' },
                { region: 'æ¿Ÿå·å³¶', reason: 'èŒ¶åœ’æ•£ç­–èˆ‡ä½å¼·åº¦å¥è¡Œ' },
                { region: 'æ²³å…§è¿‘éƒŠ', reason: 'é„‰é–“é¨è¡Œèˆ‡å¥åº·æ–™ç†' }
            ],
            'å­¸ç¿’/è€ƒå¯Ÿ': [
                { region: 'æ±äº¬', reason: 'ç”¢æ¥­åƒè¨ªèˆ‡è¨­è¨ˆèµ°è®€' },
                { region: 'æ·±åœ³', reason: 'æ–°å‰µç”Ÿæ…‹èˆ‡ç§‘æŠ€å±•æœƒ' },
                { region: 'æŸæ—', reason: 'ç¤¾æœƒè¨­è¨ˆèˆ‡åšç‰©é¤¨æ•™è‚²' },
                { region: 'æ–°åŠ å¡', reason: 'åŸå¸‚æ²»ç†èˆ‡æ°¸çºŒæ¡ˆä¾‹' },
                { region: 'å°ä¸­', reason: 'å»ºç¯‰æ¡ˆä¾‹èˆ‡éƒ½å¸‚è½‰å‹' },
                { region: 'äº¬éƒ½', reason: 'å·¥è—è¦‹å­¸èˆ‡æ–‡åŒ–è¬›åº§' }
            ],
            'é‹å‹•æ—…éŠ': [
                { region: 'æœ­å¹Œè¿‘éƒŠ', reason: 'æ»‘é›ªå ´èˆ‡å†°é›ªé‹å‹•' },
                { region: 'é•·é‡', reason: 'é«˜åŸå¥è¡Œèˆ‡å–®è»Šè·¯ç·š' },
                { region: 'èŠ±è“®', reason: 'è¶Šé‡è·‘èˆ‡æµ·é‚Šé¨è¡Œ' },
                { region: 'å³‡é‡Œå³¶', reason: 'è¡æµªé«”é©—èˆ‡æµ·ä¸Šæ´»å‹•' },
                { region: 'æ¿Ÿå·å³¶', reason: 'ç’°å³¶å–®è»Šèˆ‡æ­¥é“æŒ‘æˆ°' },
                { region: 'æ²–ç¹©', reason: 'æµ®æ½›ã€æ½›æ°´èˆ‡ SUP' }
            ]
        };
        const SUGGESTION_GROUPS = {
            'æ—¥æœ¬': ['æ±äº¬','äº¬éƒ½','å¤§é˜ª','æœ­å¹Œ','æœ­å¹Œè¿‘éƒŠ','åå¤å±‹','æ²–ç¹©','é‡‘æ¾¤','ç¥æˆ¶','æ©«æ¿±','ç®±æ ¹','åˆ¥åºœ','é•·é‡','éœå²¡'],
            'éŸ“åœ‹': ['é¦–çˆ¾','é‡œå±±','æ¿Ÿå·','æ¿Ÿå·å³¶','å¤§é‚±','å…¨å·','ä»å·','è”šå±±','è”šå±±è¿‘éƒŠ'],
            'å°ç£': ['å°åŒ—','æ–°åŒ—','æ¡ƒåœ’','æ–°ç«¹','å°ä¸­','å˜‰ç¾©','å°å—','é«˜é›„','å®œè˜­','èŠ±è“®','å°æ±','è‹—æ —'],
            'æ­æ´²': ['å·´é»','å€«æ•¦','å·´å¡éš†ç´','ç±³è˜­','ç¾…é¦¬','é˜¿å§†æ–¯ç‰¹ä¸¹','æŸæ—','ç¶­ä¹Ÿç´','å¸ƒæ‹‰æ ¼','å†°å³¶','ä¼Šæ–¯å¦å ¡']
        };
        function suggestionMatchesRegion(selectedRegion, name) {
            if (selectedRegion === 'å…¨çƒ') return true;
            const list = SUGGESTION_GROUPS[selectedRegion] || [];
            return list.some(n => name.includes(n));
        }
        function renderWheelOptions(region) {
            const list = document.getElementById('wheel-list');
            const arr = WHEEL_POOL[region] || WHEEL_POOL['å…¨çƒ'];
            list.innerHTML = arr.map(x => `<span class="chip" style="margin:4px 6px; display:inline-block;">${x}</span>`).join('');
        }
        let lastWheelPick = null;
        function renderWheelOptions(region) {
            const list = document.getElementById('wheel-list');
            const arr = WHEEL_POOL[region] || WHEEL_POOL['å…¨çƒ'];
            list.innerHTML = arr.map(x => `<span class="chip" data-name="${x}" style="margin:4px 6px; display:inline-block;">${x}</span>`).join('');
            document.getElementById('wheel-apply').disabled = !lastWheelPick;
        }
        function spinWheel() {
            const region = document.getElementById('wheel-region').value;
            const selected = Array.from(document.querySelectorAll('.wheel-theme:checked')).map(el => el.value);
            const slot = document.getElementById('wheel-result');
            if (!selected.length) {
                const pool = WHEEL_POOL[region] || WHEEL_POOL['å…¨çƒ'];
                const chips = Array.from(document.querySelectorAll('#wheel-list .chip'));
                let idx = 0;
                chips.forEach(c => c.style.background = '');
                const cycles = 24 + Math.floor(Math.random() * 12);
                let count = 0;
                const timer = setInterval(() => {
                    chips.forEach(c => c.style.background = '');
                    const c = chips[idx % chips.length];
                    if (c) c.style.background = 'var(--light-color)';
                    idx++; count++;
                    if (count >= cycles) {
                        clearInterval(timer);
                        const lastChip = chips[(idx - 1) % chips.length];
                        const pick = (lastChip && lastChip.dataset && lastChip.dataset.name) ? lastChip.dataset.name : pool[Math.floor(Math.random() * pool.length)];
                        lastWheelPick = pick;
                        slot.textContent = `æŠ½åˆ°ï¼š${pick} âœ¨`;
                        slot.style.transform = 'scale(1.05)';
                        setTimeout(()=>slot.style.transform='scale(1)', 160);
                        const applyBtn = document.getElementById('wheel-apply');
                        if (applyBtn) applyBtn.disabled = false;
                    }
                }, 60);
                return;
            }
            let candidates = [];
            selected.forEach(t => {
                (THEME_SUGGESTIONS[t] || []).forEach(s => candidates.push({ ...s, theme: t }));
            });
            if (region !== 'å…¨çƒ') {
                candidates = candidates.filter(c => suggestionMatchesRegion(region, c.region));
            }
            for (let i = candidates.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                const tmp = candidates[i]; candidates[i] = candidates[j]; candidates[j] = tmp;
            }
            const pick3 = [];
            const seen = new Set();
            for (const c of candidates) {
                const key = c.region.toLowerCase();
                if (!seen.has(key)) { pick3.push(c); seen.add(key); }
                if (pick3.length >= 3) break;
            }
            if (!pick3.length) {
                const base = (WHEEL_POOL[region] || []);
                const themeLabel = selected.join('ã€');
                for (let i = 0; i < base.length && pick3.length < 3; i++) {
                    const r = base[Math.floor(Math.random() * base.length)];
                    if (!seen.has(r.toLowerCase())) {
                        pick3.push({ region: r, reason: `å‘¼æ‡‰ã€Œ${themeLabel}ã€ä¸»é¡Œçš„åœ¨åœ°é¸æ“‡`, theme: themeLabel });
                        seen.add(r.toLowerCase());
                    }
                }
            }
            const html = pick3.map((s, i) => `
                <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:10px; margin:8px 0;">
                    <div style="font-weight:800;">${i+1}. ${s.region}</div>
                    <div style="color:#555;">ç†ç”±ï¼š${s.reason}</div>
                    <div style="margin-top:6px;">
                        <button class="tools-btn wheel-apply-suggestion" data-region="${s.region}" data-themes="${selected.join('ã€')}">âœ¨ å¥—ç”¨æ­¤åœ°å€èˆ‡ä¸»é¡Œ</button>
                    </div>
                </div>
            `).join('');
            slot.innerHTML = html;
            const applyBtn = document.getElementById('wheel-apply');
            if (applyBtn) applyBtn.disabled = true;
        }
        const IDEA_POOL = ['åœ¨åœ°åšç‰©é¤¨åƒè¨ª','è€è¡—ç¾é£Ÿæ•£æ­¥','å¤œæ™¯å±•æœ›å°','åŸå¸‚å¸‚é›†æ¢ç´¢','æµ·é‚Šæ­¥é“æ¼«éŠ','å’–å•¡é¤¨åˆå¾Œæ”¾ç©º','åœ¨åœ°å°è¦½èµ°è®€','æº«æ³‰ç™‚ç™’æ”¾é¬†','éŸ³æ¨‚é…’å§è½åœ˜','ç‰¹è‰²æ›¸åº—å°‹å¯¶'];
        function rollIdea() {
            const pick = IDEA_POOL[Math.floor(Math.random() * IDEA_POOL.length)];
            const box = document.getElementById('idea-result');
            box.textContent = `éˆæ„Ÿï¼š${pick}`;
        }
        function applyThemeAndRegionToPlanner(region, themesStr) {
            const dest = document.getElementById('destination');
            const interests = document.getElementById('interests');
            const moodSel = document.getElementById('mood_theme');
            if (dest) dest.value = region;
            if (interests) {
                const base = (interests.value || '').trim();
                const note = `ä¸»é¡Œï¼š${themesStr}`;
                interests.value = base ? (base + 'ï¼›' + note) : note;
            }
            const t = (themesStr || '').toLowerCase();
            let mood = '';
            if (t.includes('æ”¾é¬†') || t.includes('ç™‚è‚²') || t.includes('ä¼‘é–’') || t.includes('é¤Šç”Ÿ')) mood = 'æ”¾é¬†';
            else if (t.includes('æ¢ç´¢') || t.includes('éšª') || t.includes('å­¸ç¿’') || t.includes('é‹å‹•') || t.includes('ç¾é£Ÿ')) mood = 'æ¢ç´¢';
            if (moodSel && mood) moodSel.value = mood;
            switchPage('page-planner');
            if (dest) {
                dest.style.transform = 'scale(1.03)';
                setTimeout(()=>dest.style.transform='scale(1)', 160);
            }
        }
        function moodBoost() {
            const box = document.getElementById('mood-boost-result');
            const moods = [
                { label: 'æµªæ¼«', theme: 'æµªæ¼«' },
                { label: 'ç™‚ç™’', theme: 'æ”¾é¬†' },
                { label: 'æ¢ç´¢', theme: 'æ¢ç´¢' }
            ];
            const pick = moods[Math.floor(Math.random() * moods.length)];
            applyMoodTheme(pick.theme);
            box.textContent = `å·²å¥—ç”¨æ°›åœä¸»é¡Œï¼š${pick.label}`;
            box.style.transform = 'translateY(-1px)';
            setTimeout(()=>box.style.transform='translateY(0)', 120);
        }
        function switchPage(pageId) {
            ['page-planner','page-wheel','page-playground','page-scheduler','page-share'].forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.style.display = id === pageId ? 'block' : 'none';
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.page === pageId);
            });
        }
        function safeClosestFromEvent(e, selector) {
            const t = e && e.target;
            if (!t) return null;
            if (t.closest) return t.closest(selector);
            const el = t.nodeType === 3 ? t.parentElement : null;
            return el && el.closest ? el.closest(selector) : null;
        }
        
        function getItineraryPlainText() {
            if (!fullItineraryData || !fullItineraryData.days || fullItineraryData.days.length === 0) return '';
            let lines = [];
            fullItineraryData.days.forEach((dayPlan, i) => {
                lines.push(`${dayPlan.day} - ${dayPlan.date}`);
                dayPlan.items.forEach(item => {
                    lines.push(`${item.time} | ${item.type} | ${item.description} | ${item.location} | ${item.transport} | æ´»å‹• ${item.duration_activity} / äº¤é€š ${item.duration_travel} | $${item.cost} | å‚™è¨» ${item.mood_note}`);
                });
                lines.push('');
            });
            return lines.join('\n');
        }
        function exportItineraryJSON() {
            if (!fullItineraryData) return;
            const blob = new Blob([JSON.stringify(fullItineraryData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'itinerary.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function parseRetryDelaySeconds(message) {
            const m1 = String(message).match(/retryDelay":"(\d+)s/);
            if (m1) return parseInt(m1[1], 10);
            const m2 = String(message).match(/Please retry in\s+([0-9]+(\.[0-9]+)?)s/i);
            if (m2) return Math.ceil(parseFloat(m2[1]));
            return null;
        }
        function showRateLimitNotice(message) {
            const outputDiv = document.getElementById('itinerary-output');
            const secs = parseRetryDelaySeconds(message) || 20;
            const fixedDocUrl = 'https://ai.google.dev/gemini-api/docs/rate-limits';
            const html = `
                <div class="day-plan">
                    <h3>ç³»çµ±é™é¡ï¼Œç¨å¾Œå†è©¦</h3>
                    <div class="summary">ç›®å‰å·²é” ${CURRENT_MODEL} é™é¡ï¼Œå»ºè­°ç¨å€™ç´„ ${secs} ç§’æˆ–æ”¹ç”¨è¼•é‡æ¨¡å‹ã€‚</div>
                    <div style="display:flex; gap:10px; margin-top:8px;">
                        <button id="rate-switch-lite" class="tools-btn">æ”¹ç”¨è¼•é‡æ¨¡å‹ç«‹åˆ»ç”Ÿæˆ</button>
                        <button id="rate-countdown" class="tools-btn">ç­‰å¾… ${secs}s å¾Œé‡è©¦</button>
                        <a href="${fixedDocUrl}" target="_blank" class="tools-btn">äº†è§£é™é¡</a>
                    </div>
                </div>
            `;
            outputDiv.innerHTML = html;
            const genBtn = document.getElementById('generate-btn');
            if (genBtn) genBtn.disabled = true;
            let left = secs;
            const btn = document.getElementById('rate-countdown');
            const timer = setInterval(() => {
                left--;
                if (btn) btn.textContent = `ç­‰å¾… ${left}s å¾Œé‡è©¦`;
                if (left <= 0) {
                    clearInterval(timer);
                    if (genBtn) genBtn.disabled = !isKeyValid;
                    if (btn) btn.textContent = 'å¯ä»¥é‡è©¦';
                }
            }, 1000);
        }
        function isOverloaded(err) {
            const msg = String((err && err.message) || '');
            return /UNAVAILABLE|503|overloaded/i.test(msg);
        }
        async function callModelJSON(schema, contents, temperature) {
            try {
                return await aiClient.models.generateContent({
                    model: CURRENT_MODEL,
                    contents,
                    config: { responseMimeType: "application/json", responseSchema: schema, temperature }
                });
            } catch (e) {
                if (isOverloaded(e)) {
                    try {
                        await new Promise(res => setTimeout(res, (parseRetryDelaySeconds(e.message) || 2) * 1000));
                        return await aiClient.models.generateContent({
                            model: 'gemini-2.5-flash-lite',
                            contents,
                            config: { responseMimeType: "application/json", responseSchema: schema, temperature }
                        });
                    } catch (e2) {
                        showRateLimitNotice(e.message || '');
                        throw e2;
                    }
                }
                throw e;
            }
        }
        function sanitizeICS(text) {
            return String(text || '')
                .replace(/\r?\n/g, '\\n')
                .replace(/,/g, '\\,')
                .replace(/;/g, '\\;');
        }
        function parseDateValue(dateStr) {
            if (!dateStr) return null;
            const s = String(dateStr).trim();
            let m = s.match(/^(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})$/);
            if (m) {
                const y = parseInt(m[1], 10), mo = parseInt(m[2], 10) - 1, d = parseInt(m[3], 10);
                const dt = new Date(y, mo, d, 0, 0, 0);
                return dt;
            }
            m = s.match(/^(\d{4})(\d{2})(\d{2})$/);
            if (m) {
                const y = parseInt(m[1], 10), mo = parseInt(m[2], 10) - 1, d = parseInt(m[3], 10);
                const dt = new Date(y, mo, d, 0, 0, 0);
                return dt;
            }
            return null;
        }
        function parseTimeValue(timeStr) {
            if (!timeStr) return null;
            const s = String(timeStr).trim();
            let m = s.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
            if (m) {
                return { h: parseInt(m[1], 10), m: parseInt(m[2], 10), s: m[3] ? parseInt(m[3], 10) : 0 };
            }
            m = s.match(/^(\d{1,2})\s*(æ™‚|é»|hours?)\s*(\d{1,2})?\s*(åˆ†|minutes?)?$/i);
            if (m) {
                return { h: parseInt(m[1], 10), m: m[3] ? parseInt(m[3], 10) : 0, s: 0 };
            }
            return null;
        }
        function addMinutes(dateObj, minutes) {
            const dt = new Date(dateObj.getTime());
            dt.setMinutes(dt.getMinutes() + minutes);
            return dt;
        }
        function guessDurationMinutes(durationStr) {
            if (!durationStr) return 60;
            const s = String(durationStr);
            let m = s.match(/(\d+)\s*å°æ™‚|(\d+)\s*hour/i);
            if (m) {
                const num = parseInt(m[1] || m[2], 10);
                if (!isNaN(num)) return num * 60;
            }
            m = s.match(/(\d+)\s*åˆ†é˜|(\d+)\s*min/i);
            if (m) {
                const num = parseInt(m[1] || m[2], 10);
                if (!isNaN(num)) return num;
            }
            m = s.match(/(\d+)\s*~\s*(\d+)\s*åˆ†é˜/);
            if (m) {
                const a = parseInt(m[1], 10), b = parseInt(m[2], 10);
                if (!isNaN(a) && !isNaN(b)) return Math.round((a + b) / 2);
            }
            return 60;
        }
        function toICSDateTimeUTC(dt) {
            const Y = dt.getUTCFullYear();
            const M = String(dt.getUTCMonth() + 1).padStart(2, '0');
            const D = String(dt.getUTCDate()).padStart(2, '0');
            const h = String(dt.getUTCHours()).padStart(2, '0');
            const m = String(dt.getUTCMinutes()).padStart(2, '0');
            const s = String(dt.getUTCSeconds()).padStart(2, '0');
            return `${Y}${M}${D}T${h}${m}${s}Z`;
        }
        function toICSDateLocal(dt) {
            const Y = dt.getFullYear();
            const M = String(dt.getMonth() + 1).padStart(2, '0');
            const D = String(dt.getDate()).padStart(2, '0');
            return `${Y}${M}${D}`;
        }
        function exportItineraryICS() {
            if (!fullItineraryData || !fullItineraryData.days || fullItineraryData.days.length === 0) return;
            const lines = [];
            lines.push('BEGIN:VCALENDAR');
            lines.push('VERSION:2.0');
            lines.push('PRODID:-//Sense//Itinerary//ZH-TW');
            const now = new Date();
            const dtstamp = toICSDateTimeUTC(now);
            fullItineraryData.days.forEach((dayPlan, di) => {
                const baseDate = parseDateValue(dayPlan.date);
                (dayPlan.items || []).forEach((item, ii) => {
                    const timeVal = parseTimeValue(item.time);
                    let start = null;
                    if (baseDate && timeVal) {
                        start = new Date(baseDate.getFullYear(), baseDate.getMonth(), baseDate.getDate(), timeVal.h, timeVal.m, timeVal.s || 0);
                    }
                    let end = null;
                    if (start) {
                        const dur = guessDurationMinutes(item.duration_activity);
                        end = addMinutes(start, dur);
                    }
                    lines.push('BEGIN:VEVENT');
                    lines.push(`UID:sense-${di}-${ii}-${Date.now()}@local`);
                    lines.push(`DTSTAMP:${dtstamp}`);
                    if (start && end) {
                        lines.push(`DTSTART:${toICSDateTimeUTC(start)}`);
                        lines.push(`DTEND:${toICSDateTimeUTC(end)}`);
                    } else if (baseDate) {
                        const dval = toICSDateLocal(baseDate);
                        lines.push(`DTSTART;VALUE=DATE:${dval}`);
                        lines.push(`DTEND;VALUE=DATE:${dval}`);
                    } else {
                        lines.push(`DTSTART;VALUE=DATE:${toICSDateLocal(new Date())}`);
                        lines.push(`DTEND;VALUE=DATE:${toICSDateLocal(new Date())}`);
                    }
                    const summary = sanitizeICS(`${item.type} - ${item.description}`);
                    const location = sanitizeICS(item.location);
                    const desc = sanitizeICS(`äº¤é€š:${item.transport} | å‚™è¨»:${item.mood_note} | ä»‹ç´¹:${item.intro}`);
                    lines.push(`SUMMARY:${summary}`);
                    lines.push(`LOCATION:${location}`);
                    lines.push(`DESCRIPTION:${desc}`);
                    lines.push('END:VEVENT');
                });
            });
            lines.push('END:VCALENDAR');
            const icsBlob = new Blob([lines.join('\r\n')], { type: 'text/calendar' });
            const url = URL.createObjectURL(icsBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'itinerary.ics';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        function getCardImagePlaceholder() {
            return 'data:image/gif;base64,R0lGODlhAQABAAAAACw=';
        }
        function getDefaultPlaceholderImageUrl() {
            const svg = encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="600" height="400"><defs><linearGradient id="g" x1="0" x2="1" y1="0" y2="0"><stop stop-color="#e91e63" offset="0"/><stop stop-color="#ff80ab" offset="1"/></linearGradient></defs><rect width="600" height="400" fill="url(#g)"/><g fill="#fff"><rect x="200" y="150" rx="18" ry="18" width="200" height="150"/><rect x="260" y="130" rx="8" ry="8" width="80" height="30"/><rect x="310" y="210" width="50" height="8"/><circle cx="240" cy="285" r="14"/><circle cx="360" cy="285" r="14"/></g></svg>');
            return `data:image/svg+xml;charset=utf-8,${svg}`;
        }
        const IMAGE_CACHE = new Map();
        async function fetchCommonsImage(location) {
            try {
                const url = `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrsearch=${encodeURIComponent(location)}&gsrlimit=1&prop=imageinfo&iiprop=url|mime&iiurlwidth=600&format=json&origin=*`;
                const resp = await fetch(url);
                if (!resp.ok) return null;
                const data = await resp.json();
                const pages = data && data.query && data.query.pages;
                if (!pages) return null;
                const first = Object.values(pages)[0];
                const info = first && first.imageinfo && first.imageinfo[0];
                return (info && (info.thumburl || info.url)) || null;
            } catch { return null; }
        }
        async function fetchWikiSummaryThumb(location, lang) {
            try {
                const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(location)}`;
                const resp = await fetch(url);
                if (!resp.ok) return null;
                const data = await resp.json();
                const t = data && data.thumbnail && data.thumbnail.source;
                return t || null;
            } catch { return null; }
        }
        async function fetchWikiThumbByTitle(location, lang) {
            const url = `https://${lang}.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&pithumbsize=600&origin=*&titles=${encodeURIComponent(location)}`;
            const resp = await fetch(url);
            if (!resp.ok) return null;
            const data = await resp.json();
            const pages = data && data.query && data.query.pages ? data.query.pages : {};
            for (const k in pages) {
                const p = pages[k];
                if (p && p.thumbnail && p.thumbnail.source) return p.thumbnail.source;
            }
            return null;
        }
        async function fetchWikiThumbBySearch(location, lang) {
            const url = `https://${lang}.wikipedia.org/w/api.php?action=query&list=search&format=json&origin=*&srsearch=${encodeURIComponent(location)}&srlimit=1`;
            const resp = await fetch(url);
            if (!resp.ok) return null;
            const data = await resp.json();
            const s = data && data.query && data.query.search && data.query.search[0];
            if (s && s.pageid) {
                const url2 = `https://${lang}.wikipedia.org/w/api.php?action=query&prop=pageimages&format=json&pithumbsize=600&origin=*&pageids=${s.pageid}`;
                const resp2 = await fetch(url2);
                if (!resp2.ok) return null;
                const data2 = await resp2.json();
                const p = data2 && data2.query && data2.query.pages && data2.query.pages[s.pageid];
                if (p && p.thumbnail && p.thumbnail.source) return p.thumbnail.source;
            }
            return null;
        }
        async function resolveLocationImageUrl(location) {
            if (!location) return null;
            const key = location.trim().toLowerCase();
            if (IMAGE_CACHE.has(key)) return IMAGE_CACHE.get(key);
            let url = await fetchWikiSummaryThumb(location, 'zh');
            if (!url) url = await fetchWikiThumbByTitle(location, 'zh');
            if (!url) url = await fetchWikiThumbBySearch(location, 'zh');
            if (!url) url = await fetchWikiSummaryThumb(location, 'en');
            if (!url) url = await fetchWikiThumbByTitle(location, 'en');
            if (!url) url = await fetchWikiThumbBySearch(location, 'en');
            if (!url) url = await fetchCommonsImage(location);
            IMAGE_CACHE.set(key, url);
            return url;
        }
        async function enhanceCardImages() {
            const imgs = Array.from(document.querySelectorAll('.card-img[data-location]'));
            await Promise.allSettled(
                imgs.map(async img => {
                    const loc = img.getAttribute('data-location') || '';
                    const url = await resolveLocationImageUrl(loc);
                    if (url) {
                        img.src = url;
                    } else {
                        const mapUrl = generateMapEmbedUrl(loc);
                        const iframe = document.createElement('iframe');
                        iframe.className = 'card-map';
                        iframe.loading = 'lazy';
                        iframe.src = mapUrl;
                        img.replaceWith(iframe);
                    }
                })
            );
        }
        function renderDestinationCards() {
            const section = document.getElementById('cards-section');
            const grid = document.getElementById('destination-cards');
            if (!section || !grid) return;
            if (!fullItineraryData || !fullItineraryData.days || fullItineraryData.days.length === 0) {
                section.style.display = 'none';
                grid.innerHTML = '';
                return;
            }
            const seen = new Map();
            fullItineraryData.days.forEach((dayPlan, di) => {
                (dayPlan.items || []).forEach(item => {
                    const key = (item.location || '').trim().toLowerCase();
                    if (!key) return;
                    if (!seen.has(key)) {
                        seen.set(key, { location: item.location, types: new Set([item.type]), days: new Set([dayPlan.day]) });
                    } else {
                        const obj = seen.get(key);
                        obj.types.add(item.type);
                        obj.days.add(dayPlan.day);
                    }
                });
            });
            const cards = [];
            seen.forEach(obj => {
                const types = Array.from(obj.types).join('/');
                const days = Array.from(obj.days).join('ã€');
                const placeholder = getCardImagePlaceholder();
                const imgTag = `<img class="card-img" src="${placeholder}" data-location="${obj.location}" alt="${obj.location}" loading="lazy" referrerpolicy="no-referrer">`;
                const mapUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(obj.location)}`;
                const imgSearch = generateImageSearchUrl(obj.location);
                cards.push(`
                    <div class="card">
                        ${imgTag}
                        <div class="card-body">
                            <div class="card-title">${obj.location}</div>
                            <div class="card-tags">
                                <span class="chip">${types}</span>
                                <span class="chip">${days}</span>
                            </div>
                            <div class="card-actions">
                                <a href="${imgSearch}" target="_blank" class="tools-btn">ğŸ“¸ åœ–ç‰‡</a>
                                <a href="${mapUrl}" target="_blank" class="tools-btn">ğŸ—ºï¸ åœ°åœ–</a>
                            </div>
                        </div>
                    </div>
                `);
            });
            grid.innerHTML = cards.join('');
            section.style.display = cards.length ? 'block' : 'none';
            if (cards.length) enhanceCardImages();
        }
        async function copyItineraryText() {
            const text = getItineraryPlainText();
            if (!text) return;
            try {
                await navigator.clipboard.writeText(text);
            } catch {}
        }
        function printItinerary() {
            window.print();
        }

        // å‡½å¼ï¼šç”Ÿæˆ Google åœ–ç‰‡æœå°‹é€£çµ
        function generateImageSearchUrl(location) {
            const encodedLocation = encodeURIComponent(location);
            return `https://www.google.com/search?tbm=isch&q=${encodedLocation}`;
        }
        function loadSharedPosts() {
            try {
                const raw = localStorage.getItem('sharedPosts');
                sharedPosts = raw ? JSON.parse(raw) : [];
            } catch { sharedPosts = []; }
        }
        function saveSharedPosts() {
            try {
                localStorage.setItem('sharedPosts', JSON.stringify(sharedPosts));
            } catch {}
        }
        async function seedShareExamples() {
            try {
                const seeded = localStorage.getItem('shareExamplesSeeded');
                if (seeded) return;
                if (sharedPosts && sharedPosts.length) return;
                const examples = [
                    { title: 'æ±äº¬å¤œæ™¯', location: 'æ±äº¬æ™´ç©ºå¡”', text: 'å¤œæ™¯å¾ˆç¾ï¼Œäº¤é€šæ–¹ä¾¿' },
                    { title: 'æ·ºè‰å¯ºåƒè¨ª', location: 'æ·ºè‰å¯º', text: 'æ–‡åŒ–æ°£æ¯æ¿ƒåš' },
                    { title: 'é“é “å €ç¾é£Ÿ', location: 'é“é “å €', text: 'ç« é­šç‡’å¾ˆå¥½åƒ' }
                ];
                for (const ex of examples) {
                    const img = await resolveLocationImageUrl(ex.location);
                    sharedPosts.push({
                        id: Date.now() + Math.random(),
                        title: ex.title,
                        text: ex.text,
                        location: ex.location,
                        imageUrl: img || getDefaultPlaceholderImageUrl(),
                        createdAt: new Date().toISOString()
                    });
                }
                saveSharedPosts();
                localStorage.setItem('shareExamplesSeeded', '1');
            } catch {}
        }
        function renderSharePosts() {
            const grid = document.getElementById('share-posts');
            if (!grid) return;
            if (!sharedPosts || !sharedPosts.length) {
                grid.innerHTML = '';
                return;
            }
            const cards = sharedPosts.map(p => {
                const imgSrc = p.imageDataUrl || p.imageUrl || getDefaultPlaceholderImageUrl();
                const locChip = p.location ? `<span class="chip">${p.location}</span>` : '';
                return `
                    <div class="card">
                        <img class="card-img" src="${imgSrc}" alt="${p.title}" loading="lazy" referrerpolicy="no-referrer">
                        <div class="card-body">
                            <div class="card-title">${p.title || ''}</div>
                            <div class="card-tags">${locChip}</div>
                            <div>${p.text || ''}</div>
                        </div>
                    </div>
                `;
            });
            grid.innerHTML = cards.join('');
        }
        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const fr = new FileReader();
                fr.onload = () => resolve(fr.result);
                fr.onerror = reject;
                fr.readAsDataURL(file);
            });
        }
        async function handleShareSubmit() {
            const titleEl = document.getElementById('share-title');
            const locEl = document.getElementById('share-location');
            const textEl = document.getElementById('share-text');
            const photoEl = document.getElementById('share-photo');
            const title = titleEl ? titleEl.value.trim() : '';
            const location = locEl ? locEl.value.trim() : '';
            const text = textEl ? textEl.value.trim() : '';
            const files = photoEl && photoEl.files ? Array.from(photoEl.files) : [];
            let imageDataUrl = '';
            let imageUrl = '';
            if (files.length) {
                imageDataUrl = await readFileAsDataUrl(files[0]);
            } else if (location) {
                const url = await resolveLocationImageUrl(location);
                imageUrl = url || '';
            }
            if (!imageDataUrl && !imageUrl) {
                return;
            }
            const post = {
                id: Date.now(),
                title,
                text,
                location,
                imageDataUrl,
                imageUrl,
                createdAt: new Date().toISOString()
            };
            sharedPosts.unshift(post);
            saveSharedPosts();
            renderSharePosts();
            if (titleEl) titleEl.value = '';
            if (locEl) locEl.value = '';
            if (textEl) textEl.value = '';
            if (photoEl) photoEl.value = '';
        }
        async function initShareBoard() {
            loadSharedPosts();
            await seedShareExamples();
            renderSharePosts();
        }
        // å‡½å¼ï¼šç”Ÿæˆæƒ…ç·’é¸æ“‡ä¸‹æ‹‰é¸å–®
        function generateMoodSelect(dayIndex) {
            let options = MOOD_OPTIONS.map(mood => 
                `<option value="${mood.value}">${mood.label}</option>`
            ).join('');
            
            return `
                <select class="day-mood-select" data-day-index="${dayIndex}">
                    <option value="" disabled selected>é¸æ“‡ä»Šæ—¥å¿ƒæƒ…</option>
                    ${options}
                </select>
            `;
        }
        
        // åœ°åœ–åµŒå…¥å‡½å¼
        function generateMapEmbedUrl(location) {
            const encodedLocation = encodeURIComponent(location);
            return `https://maps.google.com/maps?q=${encodedLocation}&output=embed&z=14&hl=zh-TW`; 
        }
        // æ—¥æœŸè¼”åŠ©å‡½å¼
        function formatDate(dt) {
            var Y = dt.getFullYear();
            var M = String(dt.getMonth() + 1).padStart(2, '0');
            var D = String(dt.getDate()).padStart(2, '0');
            return Y + '-' + M + '-' + D;
        }
        function addDays(dateObj, days) {
            var dt = new Date(dateObj.getTime());
            dt.setDate(dt.getDate() + days);
            return dt;
        }
        function pickRandomFutureDate(rangeDays) {
            var r = typeof rangeDays === 'number' ? rangeDays : 90;
            var base = new Date();
            var offset = Math.floor(Math.random() * Math.max(2, r)) + 1;
            return addDays(base, offset);
        }
        function computeStartDate() {
            var stratEl = document.getElementById('start_date_strategy');
            var valueEl = document.getElementById('start_date_value');
            var strategy = stratEl ? stratEl.value : 'tomorrow';
            if (strategy === 'tomorrow') {
                var base = new Date();
                return addDays(base, 1);
            } else if (strategy === 'random') {
                return pickRandomFutureDate(90);
            } else if (strategy === 'specific') {
                var v = valueEl ? valueEl.value : '';
                if (!v) return null;
                var dt = new Date(v);
                if (isNaN(dt.getTime())) return null;
                return dt;
            } else {
                var base2 = new Date();
                return addDays(base2, 1);
            }
        }
        // å¾ä¸€å¥è©±è¨˜éŒ„ä¸­æ¨æ¸¬éš”å¤©é–‹å§‹æ™‚é–“ï¼ˆç°¡å–®ä¸­æ–‡/æ•¸å­—è¦å‰‡ï¼‰
        function deriveStartTimeFromText(text) {
            var s = String(text || '').toLowerCase();
            var m;
            m = s.match(/(\d{1,2})\s*(?:[:ï¼š](\d{2}))?\s*(?:é»|æ™‚)/);
            if (m) {
                var hh = parseInt(m[1], 10);
                var mm = m[2] ? m[2] : '00';
                if (hh >= 0 && hh <= 23) return String(hh).padStart(2,'0') + ':' + mm;
            }
            m = s.match(/(\d{1,2})\s*(am|pm)/);
            if (m) {
                var hh2 = parseInt(m[1], 10);
                var ampm = m[2];
                if (ampm === 'pm' && hh2 < 12) hh2 += 12;
                if (ampm === 'am' && hh2 === 12) hh2 = 0;
                return String(hh2).padStart(2,'0') + ':00';
            }
            if (s.includes('æ™šèµ·') || s.includes('å¤ªç´¯') || s.includes('ç¡åˆ°') || s.includes('æ™šä¸€é»é–‹å§‹')) {
                return '11:00';
            }
            return null;
        }
        function parseTimeToMinutes(t) {
            var m = String(t || '').match(/(\d{1,2}):(\d{2})/);
            if (!m) return null;
            var h = parseInt(m[1],10);
            var mi = parseInt(m[2],10);
            if (isNaN(h) || isNaN(mi)) return null;
            return h*60 + mi;
        }
        function formatMinutesToTime(mins) {
            var m = Math.max(0, mins|0);
            var h = Math.floor(m/60)%24;
            var mi = m%60;
            return String(h).padStart(2,'0') + ':' + String(mi).padStart(2,'0');
        }
        function shiftDayStart(dayPlan, startTimeStr) {
            if (!startTimeStr) return dayPlan;
            var minStart = parseTimeToMinutes(startTimeStr);
            if (minStart == null || !dayPlan || !dayPlan.items || !dayPlan.items.length) return dayPlan;
            var first = parseTimeToMinutes(dayPlan.items[0].time);
            if (first == null) return dayPlan;
            if (first < minStart) {
                var delta = minStart - first;
                dayPlan.items.forEach(function(it){
                    var mm = parseTimeToMinutes(it.time);
                    if (mm != null) it.time = formatMinutesToTime(mm + delta);
                });
            }
            return dayPlan;
        }
        function ensureRestBreak(dayPlan, mood, sentence, startTimeStr, destination) {
            var tired = String(mood || '').includes('ç–²') || String(sentence || '').includes('ç´¯') || String(sentence || '').includes('ä¼‘æ¯') || String(sentence || '').includes('ç¡');
            if (!tired) return dayPlan;
            if (!dayPlan || !dayPlan.items) return dayPlan;
            var firstTime = startTimeStr || (dayPlan.items[0] ? dayPlan.items[0].time : '11:00');
            var m = parseTimeToMinutes(firstTime);
            var insertTime = formatMinutesToTime((m != null ? m : 660) + 30);
            var hasRest = dayPlan.items.some(function(it){ return String(it.description||'').includes('ä¼‘æ¯') || String(it.type||'')==='é¤é£Ÿ'; });
            if (!hasRest) {
                var restItem = {
                    time: insertTime,
                    description: 'å’–å•¡é¤¨ä¼‘æ¯èˆ‡æ—©åˆé¤',
                    intro: 'ä»¥è¼•é¬†æ­¥èª¿é–‹å§‹ä¸€å¤©ï¼Œè£œå……èƒ½é‡ä¸¦æ”¾é¬†èº«å¿ƒã€‚',
                    mood_note: 'èˆ’ç·©ç–²æ†Šã€æ”¾æ…¢ç¯€å¥ï¼Œè®“èº«å¿ƒæ¢å¾©ã€‚',
                    type: 'é¤é£Ÿ',
                    location: destination || 'å¸‚ä¸­å¿ƒå’–å•¡é¤¨',
                    transport: 'æ­¥è¡Œ',
                    duration_activity: '60åˆ†é˜',
                    duration_travel: '10åˆ†é˜',
                    cost: 300
                };
                dayPlan.items.unshift(restItem);
            }
            return dayPlan;
        }
        function adjustDayPlanByMood(dayPlan, diaryMood, diarySentence, startTimeStr, destination) {
            var adjusted = shiftDayStart(dayPlan, startTimeStr);
            adjusted = ensureRestBreak(adjusted, diaryMood, diarySentence, startTimeStr, destination);
            return adjusted;
        }
        function computeMeterAdvice(r, h, e) {
            const top = [['æµªæ¼«', r], ['ç™‚ç™’', h], ['æ¢ç´¢', e]].sort((a,b)=>b[1]-a[1])[0][0];
            if (top === 'æµªæ¼«') return 'ä»Šå¤©ä»¥æµªæ¼«ç‚ºæ ¸å¿ƒï¼Œå®‰æ’æ…¢æ­¥ã€å¤œæ™¯èˆ‡å…±äº«ç”œé»ã€‚';
            if (top === 'ç™‚ç™’') return 'ä»Šå¤©ä»¥ç™‚ç™’ç‚ºæ ¸å¿ƒï¼Œå®‰æ’ç¶ åœ°ã€å’–å•¡ã€è¼•éŸ³æ¨‚èˆ‡æ·±å‘¼å¸ã€‚';
            return 'ä»Šå¤©ä»¥æ¢ç´¢ç‚ºæ ¸å¿ƒï¼Œå®‰æ’å¸‚é›†ã€åœ¨åœ°è¡—å€èˆ‡æ–°å˜—è©¦ã€‚';
        }
        function applyMeterTheme() {
            const r = parseInt(document.getElementById('meter-romance').value, 10);
            const h = parseInt(document.getElementById('meter-heal').value, 10);
            const e = parseInt(document.getElementById('meter-explore').value, 10);
            const advice = computeMeterAdvice(r, h, e);
            document.getElementById('meter-advice').textContent = advice;
            const theme = r >= h && r >= e ? 'æµªæ¼«' : (h >= r && h >= e ? 'æ”¾é¬†' : 'æ¢ç´¢');
            applyMoodTheme(theme);
        }
        
        const PLAYLIST_QUERY = {
            'æµªæ¼«': 'romantic+lofi+night+city',
            'æ”¾é¬†': 'relaxing+ambient+coffee+lofi',
            'æ¢ç´¢': 'adventure+city+vibe+lofi'
        };
        function playPlaylist() {
            const mood = document.getElementById('playlist-mood').value;
            const audio = document.getElementById('mood-audio');
            const q = PLAYLIST_QUERY[mood] || PLAYLIST_QUERY['æ”¾é¬†'];
            const yt = `https://www.youtube.com/results?search_query=${encodeURIComponent(q)}`;
            document.getElementById('playlist-link').href = yt;
            const cfg = MOOD_CONFIG[mood] || MOOD_CONFIG['default'];
            if (cfg.audio_url) {
                audio.src = cfg.audio_url;
                audio.volume = 0.35;
                audio.play().catch(()=>{});
                document.getElementById('playlist-status').textContent = `å·²æ’­æ”¾ ${mood} é…æ¨‚ï¼Œé»å³å´å¯æ–¼ YouTube æ¢ç´¢æ›´å¤šã€‚`;
            } else {
                audio.pause();
                document.getElementById('playlist-status').textContent = `ç„¡æ³•æ’­æ”¾ ${mood} é…æ¨‚ï¼Œè«‹æ–¼ YouTube é€£çµä¸­é¸æ“‡ã€‚`;
            }
        }

        // ä¸»å‡½å¼ï¼šç”Ÿæˆè¡Œç¨‹
        async function generateItinerary() {
            const destination = document.getElementById('destination').value.trim();
            const duration = document.getElementById('duration').value.trim();
            const travelers = document.getElementById('travelers').value.trim();
            const budget = document.getElementById('budget').value;
            const transport = document.getElementById('transport').value;
            const moodTheme = document.getElementById('mood_theme').value.trim();
            const currentMood = document.getElementById('current_mood').value;
            const interests = document.getElementById('interests').value.trim();
            const outputDiv = document.getElementById('itinerary-output');
            const analyzeBtn = document.getElementById('analyze-mood-btn');
            
            if (!isKeyValid || !aiClient) {
                outputDiv.innerHTML = "<p style='color:red;'>è«‹å…ˆé©—è­‰æ‚¨çš„ Gemini API Keyã€‚</p>";
                return;
            }
            if (!destination || !duration || !travelers || !moodTheme) {
                outputDiv.innerHTML = "<p style='color:red;'>è«‹è¼¸å…¥æ—…éŠåœ°å€ã€å¤©æ•¸ã€äººæ•¸å’Œæ—…éŠä¸»é¡Œã€‚</p>";
                return;
            }
            const startDt = computeStartDate();
            if (!startDt) {
                outputDiv.innerHTML = "<p style='color:red;'>è«‹é¸æ“‡é–‹å§‹æ—¥æœŸã€‚</p>";
                return;
            }
            itineraryStartDate = startDt;
            const startDateStr = formatDate(startDt);

            setButtonState('generate-btn', true, 'ç”Ÿæˆä¸­...');
            analyzeBtn.style.display = 'none';
            document.getElementById('final-mood-summary').innerHTML = '';
            outputDiv.innerHTML = "<div class='loading'>æ­£åœ¨å‘¼å« AI è¦åŠƒè¡Œç¨‹ï¼Œè«‹ç¨å€™...</div>";

            try {
                applyMoodTheme(moodTheme);

                const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ³¨æ–¼ã€Œå€‹äººåŒ–æƒ…ç·’åƒ¹å€¼ã€çš„æ—…éŠè¦åŠƒå¸«ã€‚è«‹åªè¼¸å‡ºç¬¦åˆ Schema çš„ JSONã€‚
                åœ°é»ï¼š${destination}
                åŒè¡Œäººæ•¸ï¼š${travelers}
                é ç®—ï¼š${budget}
                äº¤é€šæ–¹å¼ï¼š${transport}
                ä¸»é¡Œï¼š${moodTheme}
                ä½¿ç”¨è€…ç¾åœ¨å¿ƒæƒ…ï¼š${currentMood}
                é¡å¤–éœ€æ±‚ï¼š${interests || 'ç„¡'}
                ç¬¬ä¸€æ—¥æ—¥æœŸï¼š${startDateStr}
                è«‹ç”Ÿæˆã€Œå–®ä¸€å¤©ã€çš„è©³ç´°è¡Œç¨‹ï¼Œæ™‚é–“é€£è²«ã€å…·é«”åœ°é»èˆ‡å¯¦éš›è²»ç”¨ä¼°è¨ˆï¼Œä¿ç•™æƒ…æ„Ÿå‚™è¨»ã€‚
                `;
                const response = await callModelJSON(DAY_SCHEMA, prompt, 0.8);
                const dayPlan = JSON.parse(response.text);
                dayPlan.date = startDateStr;
                fullItineraryData = { days: [dayPlan] };
                collectVisited(dayPlan.items);
                let totalCost = 0;
                let dailyHtml = '';
                dayPlan.items.forEach(item => {
                    const costValue = parseInt(item.cost) || 0;
                    totalCost += costValue;
                    const mapLink = generateMapEmbedUrl(item.location);
                    const imageLink = generateImageSearchUrl(item.location);
                    dailyHtml += `
                        <tr>
                            <td class="time-col">${item.time}</td>
                            <td class="duration-col">
                                æ´»å‹•: ${item.duration_activity}<br>
                                <span style="color:#d32f2f;">äº¤é€š: ${item.duration_travel}</span>
                            </td>
                            <td class="item-col">
                                <span class="chip">${item.type}</span> ${item.description}<br>
                                <div class="mood-note">âœ¨ **æƒ…æ„Ÿå‚™è¨»ï¼š** ${item.mood_note}</div>
                                <div class="note-intro">**ä»‹ç´¹ï¼š** ${item.intro}</div>
                                <small>åœ°é»ï¼š${item.location}</small>
                                <a class="image-btn" href="${imageLink}" target="_blank" title="é»æ“ŠæŸ¥çœ‹è©²åœ°é»çš„åœ–ç‰‡">ğŸ“¸ åœ–ç‰‡åƒè€ƒ</a>
                            </td>
                            <td class="transport-col">${item.transport}</td>
                            <td class="cost-col">$${costValue}</td>
                        </tr>
                        <tr>
                            <td colspan="5" style="padding-top: 0;">
                                <div class="map-container">
                                    <iframe class="map-iframe" loading="lazy" src="${mapLink}" allowfullscreen></iframe>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                let htmlContent = `<h2>âœˆï¸ ç‚ºæ‚¨è¦åŠƒçš„ ${destination} ç¬¬ä¸€å¤© (${moodTheme}) è¡Œç¨‹</h2>`;
                htmlContent += `
                    <div class="day-plan">
                        <h3 id="day-title-0">${dayPlan.day} - ${dayPlan.date}</h3>
                        <div class="table-wrapper">
                            <table class="itinerary-table">
                                <thead>
                                    <tr>
                                        <th class="time-col">é–‹å§‹æ™‚é–“</th>
                                        <th class="duration-col">é ä¼°æ™‚é•·</th>
                                        <th class="item-col">é …ç›® (é¡å‹/æƒ…ç·’)</th>
                                        <th class="transport-col">äº¤é€š</th>
                                        <th class="cost-col">é ä¼°é‡‘é¡ (TWD)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dailyHtml}
                                </tbody>
                            </table>
                        </div>
                        <div class="summary">ç•¶æ—¥ç¸½é ä¼°èŠ±è²»ï¼š$${totalCost} TWD</div>
                    </div>
                `;
                outputDiv.innerHTML = htmlContent;
                analyzeBtn.style.display = 'none';
                const tb = document.getElementById('tools-bar');
                if (tb) tb.style.display = 'flex';
                renderDestinationCards();

            } catch (error) {
                console.error("ç”Ÿæˆè¡Œç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                if (/RESOURCE_EXHAUSTED|429|quota|rate|UNAVAILABLE|503/i.test(String(error.message || ''))) {
                    showRateLimitNotice(error.message || '');
                } else {
                    let errorMsg = error.message.includes('Unexpected token') || error.message.includes('JSON') ?
                        'è¡Œç¨‹ç”Ÿæˆå¤±æ•—ã€‚AI å›å‚³çš„ JSON æ ¼å¼ä¸æ­£ç¢ºã€‚è«‹å˜—è©¦ç°¡åŒ–æ‚¨çš„éœ€æ±‚æˆ–æª¢æŸ¥ Key ç‹€æ…‹ã€‚' :
                        `è¡Œç¨‹ç”Ÿæˆå¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯ï¼š${error.message}`;
                    outputDiv.innerHTML = `<p style='color:red;'>${errorMsg}</p>`;
                }
            } finally {
                setButtonState('generate-btn', false, 'ğŸ’– ç‚ºæˆ‘ç”Ÿæˆå……æ»¿æƒ…ç·’åƒ¹å€¼çš„å°ˆå±¬è¡Œç¨‹');
            }
        }

        async function generateNextDay(prevDayIndex) {
            const destination = document.getElementById('destination').value.trim();
            const travelers = document.getElementById('travelers').value.trim();
            const budget = document.getElementById('budget').value;
            const transport = document.getElementById('transport').value;
            const moodTheme = document.getElementById('mood_theme').value.trim();
            const currentMood = document.getElementById('current_mood').value;
            const interests = document.getElementById('interests').value.trim();
            const inScheduler = document.getElementById('page-scheduler') && document.getElementById('page-scheduler').style.display === 'block';
            const outputDiv = inScheduler ? document.getElementById('scheduler-output') : document.getElementById('itinerary-output');
            const nextBtn = document.querySelector(`.next-day-btn[data-prev-day-index="${prevDayIndex}"]`);
            const originalText = nextBtn ? nextBtn.textContent : '';
            if (nextBtn) {
                nextBtn.disabled = true;
                nextBtn.textContent = 'ç”Ÿæˆä¸­...';
                nextBtn.classList.add('btn-loading');
            }
            try {
                if (!isKeyValid || !aiClient) {
                    outputDiv.insertAdjacentHTML('beforeend', `<div class="summary">è«‹å…ˆé©—è­‰æ‚¨çš„ Gemini API Keyã€‚</div>`);
                    return;
                }
                const moodSelect = document.querySelector(`.day-mood-select[data-day-index="${prevDayIndex}"]`);
                const sentenceInput = document.querySelector(`.day-sentence-input[data-day-index="${prevDayIndex}"]`);
                const savedLog = userDiaryLogs.find(x => x.dayIndex === prevDayIndex);
                const diaryMood = savedLog ? (savedLog.mood || '') : (moodSelect ? moodSelect.value : '');
                const diarySentence = savedLog ? (String(savedLog.sentence || '').trim()) : (sentenceInput ? sentenceInput.value.trim() : '');
                const dayIndex = prevDayIndex + 1;
                const startTime = deriveStartTimeFromText(diarySentence);
                const originalNext = (fullItineraryData && fullItineraryData.days && fullItineraryData.days[dayIndex]) ? fullItineraryData.days[dayIndex] : null;
                const originalList = originalNext ? originalNext.items.map(it => `${it.time} ${it.type} ${it.description} @${it.location}`).join('\n') : '';
                const computedDate = itineraryStartDate ? formatDate(addDays(itineraryStartDate, dayIndex)) : '';
                const prompt = `
                è«‹æ ¹æ“šä½¿ç”¨è€…åœ¨ç¬¬ ${prevDayIndex+1} å¤©çš„æ„Ÿå—ï¼Œèª¿æ•´ã€Œç¬¬ ${dayIndex+1} å¤©ã€çš„è©³ç´°è¡Œç¨‹ã€‚åªè¼¸å‡º JSONï¼Œéµå®ˆ Schemaã€‚
                åœ°é»ï¼š${destination}
                åŒè¡Œäººæ•¸ï¼š${travelers}
                é ç®—ï¼š${budget}
                äº¤é€šæ–¹å¼ï¼š${transport}
                ä¸»é¡Œï¼š${moodTheme}
                ä½¿ç”¨è€…ç›®å‰å¿ƒæƒ…ï¼š${currentMood}
                é¡å¤–éœ€æ±‚ï¼š${interests || 'ç„¡'}
                å‰ä¸€æ—¥å¿ƒæƒ…å›é¥‹ï¼š${diaryMood || 'æœªé¸æ“‡'}
                å‰ä¸€æ—¥ä¸€å¥è©±æ—¥è¨˜ï¼š"${diarySentence || 'æœªå¡«'}"
                ${computedDate ? `ç•¶æ—¥æ—¥æœŸï¼š${computedDate}` : ''}
                é¿å…é‡è¤‡ä»¥ä¸‹åœ°é»ï¼š${Array.from(visitedLocations).join(', ') || 'ï¼ˆç„¡ï¼‰'}
                é¿å…é‡è¤‡ä»¥ä¸‹é …ç›®ï¼š${Array.from(visitedDescriptions).join(', ') || 'ï¼ˆç„¡ï¼‰'}
                ${startTime ? `ç¡¬æ€§ç´„æŸï¼šæœ¬æ—¥é–‹å§‹æ™‚é–“ä¸å¾—æ—©æ–¼ ${startTime}ã€‚` : ''}
                ${originalNext ? `åŸæœ¬è¨ˆç•«ï¼ˆè«‹ç›¡é‡ä¿ç•™ä¸¦åƒ…å¾®èª¿æ™‚é–“èˆ‡é †åºï¼‰ï¼š\n${originalList}` : ''}
                å…·é«”è¦æ±‚ï¼š
                1) æ´»å‹•å®‰æ’éœ€å‘¼æ‡‰ä¸Šè¿°å¿ƒæƒ…èˆ‡åå¥½ï¼Œå…·é«”åœ°é»èˆ‡è²»ç”¨ä¼°è¨ˆã€‚
                2) è‹¥æœ‰ ${startTime || 'æ—©ä¸Š'} å‰çš„æ´»å‹•ï¼Œè«‹å»¶å¾Œåˆ° ${startTime || 'ä¸Šåˆç¨æ™š'} ä¹‹å¾Œæˆ–ä»¥æ—©åˆé¤/ä¼‘æ¯å–ä»£ã€‚
                3) å„ªå…ˆä¿ç•™æ—¢æœ‰åœ°é»èˆ‡é …ç›®ï¼Œå¿…è¦æ™‚åƒ…åšå¾®èª¿èˆ‡åˆªæ¸›æ™¨é–“å®‰æ’ã€‚
                4) ç¦æ­¢èˆ‡å‰å¹¾å¤©å…§å®¹é‡è¤‡ã€‚
                `;
                const response = await callModelJSON(DAY_SCHEMA, prompt, 0.75);
                let dayPlan = JSON.parse(response.text);
                if (hasDuplicates(dayPlan.items)) {
                    const retry = `
                    é‡æ–°ç”Ÿæˆç¬¬äºŒå¤©ï¼Œåš´æ ¼é¿å…é‡è¤‡ã€‚åªè¼¸å‡º JSONã€‚
                    åœ°é»ï¼š${destination}
                    åŒè¡Œäººæ•¸ï¼š${travelers}
                    é ç®—ï¼š${budget}
                    äº¤é€šæ–¹å¼ï¼š${transport}
                    ä¸»é¡Œï¼š${moodTheme}
                    ç¦æ­¢é‡è¤‡åœ°é»ï¼š${Array.from(visitedLocations).join(', ') || 'ï¼ˆç„¡ï¼‰'}
                    ç¦æ­¢é‡è¤‡é …ç›®ï¼š${Array.from(visitedDescriptions).join(', ') || 'ï¼ˆç„¡ï¼‰'}
                    ç¬¬ä¸€æ—¥å¿ƒæƒ…ï¼š${diaryMood || 'æœªé¸æ“‡'}ï¼›ä¸€å¥è©±ï¼š"${diarySentence || 'æœªå¡«'}"
                    å¿…é ˆæä¾›å…·é«”åœ°é»åç¨±èˆ‡è²»ç”¨ä¼°è¨ˆã€‚
                    `;
                    const resp2 = await callModelJSON(DAY_SCHEMA, retry, 0.6);
                    dayPlan = JSON.parse(resp2.text);
                }
                dayPlan = adjustDayPlanByMood(dayPlan, diaryMood, diarySentence, startTime, destination);
                if (computedDate) dayPlan.date = computedDate;
                if (inScheduler && originalNext) {
                    fullItineraryData.days[dayIndex] = dayPlan;
                } else {
                    fullItineraryData.days.push(dayPlan);
                }
                collectVisited(dayPlan.items);
                let totalCost = 0;
                let dailyHtml = '';
                dayPlan.items.forEach(item => {
                    const costValue = parseInt(item.cost) || 0;
                    totalCost += costValue;
                    const mapLink = generateMapEmbedUrl(item.location);
                    const imageLink = generateImageSearchUrl(item.location);
                    dailyHtml += `
                        <tr>
                            <td class="time-col">${item.time}</td>
                            <td class="duration-col">
                                æ´»å‹•: ${item.duration_activity}<br>
                                <span style="color:#d32f2f;">äº¤é€š: ${item.duration_travel}</span>
                            </td>
                            <td class="item-col">
                                <span class="chip">${item.type}</span> ${item.description}<br>
                                <div class="mood-note">âœ¨ **æƒ…æ„Ÿå‚™è¨»ï¼š** ${item.mood_note}</div>
                                <div class="note-intro">**ä»‹ç´¹ï¼š** ${item.intro}</div>
                                <small>åœ°é»ï¼š${item.location}</small>
                                <a class="image-btn" href="${imageLink}" target="_blank" title="é»æ“ŠæŸ¥çœ‹è©²åœ°é»çš„åœ–ç‰‡">ğŸ“¸ åœ–ç‰‡åƒè€ƒ</a>
                            </td>
                            <td class="transport-col">${item.transport}</td>
                            <td class="cost-col">$${costValue}</td>
                        </tr>
                        <tr>
                            <td colspan="5" style="padding-top: 0;">
                                <div class="map-container">
                                    <iframe class="map-iframe" loading="lazy" src="${mapLink}" allowfullscreen></iframe>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                const currentIndex = inScheduler ? dayIndex : (fullItineraryData.days.length - 1);
                const markup = `
                    <div class="day-plan">
                        <h3 id="day-title-${currentIndex}">${dayPlan.day} - ${dayPlan.date || ('Day ' + (currentIndex+1))}</h3>
                        <div class="table-wrapper">
                            <table class="itinerary-table">
                                <thead>
                                    <tr>
                                        <th class="time-col">é–‹å§‹æ™‚é–“</th>
                                        <th class="duration-col">é ä¼°æ™‚é•·</th>
                                        <th class="item-col">é …ç›® (é¡å‹/æƒ…ç·’)</th>
                                        <th class="transport-col">äº¤é€š</th>
                                        <th class="cost-col">é ä¼°é‡‘é¡ (TWD)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dailyHtml}
                                </tbody>
                            </table>
                        </div>
                        <div class="summary">ç•¶æ—¥ç¸½é ä¼°èŠ±è²»ï¼š$${totalCost} TWD</div>
                        <div class="feedback-container" data-day-index="${currentIndex}">
                            <div>
                                <label for="mood-select-${currentIndex}">ä»Šæ—¥æ„Ÿå—ï¼š</label>
                                ${generateMoodSelect(currentIndex)}
                            </div>
                            <div>
                                <label for="sentence-input-${currentIndex}">ä¸€å¥è©±è¨˜éŒ„ï¼š</label>
                                <input type="text" id="sentence-input-${currentIndex}" placeholder="ä¾‹å¦‚ï¼šåœ¨å±…é…’å±‹çš„ç†±é¬§æ°£æ°›è®“æˆ‘æ„Ÿåˆ°å¾ˆæ»¿è¶³" class="day-sentence-input" data-day-index="${currentIndex}">
                            </div>
                        </div>
                        <div style="margin-top:8px; display:flex; gap:8px;">
                            <button class="tools-btn btn-save-diary" data-day-index="${currentIndex}">ğŸ“ å„²å­˜ä»Šæ—¥æ—¥è¨˜</button>
                            <button class="next-day-btn" data-prev-day-index="${currentIndex}">â¡ï¸ æ ¹æ“šæˆ‘çš„æ—¥è¨˜èª¿æ•´éš”å¤©è¡Œç¨‹</button>
                        </div>
                    </div>
                `;
                if (inScheduler) {
                    const container = document.getElementById(`day-plan-${currentIndex}`) || document.getElementById(`day-title-${currentIndex}`)?.closest('.day-plan');
                    if (container) {
                        container.outerHTML = markup;
                    } else {
                        outputDiv.insertAdjacentHTML('beforeend', markup);
                    }
                } else {
                    outputDiv.insertAdjacentHTML('beforeend', markup);
                }
                const analyzeBtn = document.getElementById('analyze-mood-btn');
                if (analyzeBtn) analyzeBtn.style.display = 'block';
                if (nextBtn) nextBtn.disabled = false;
                const tb = document.getElementById('tools-bar');
                if (tb) tb.style.display = 'flex';
                renderDestinationCards();
            } catch (error) {
                if (/RESOURCE_EXHAUSTED|429|quota|rate|UNAVAILABLE|503/i.test(String(error.message || ''))) {
                    showRateLimitNotice(error.message || '');
                } else {
                    outputDiv.insertAdjacentHTML('beforeend', `<div class="summary">ç”Ÿæˆä¸‹ä¸€å¤©å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦ã€‚</div>`);
                }
            } finally {
                if (nextBtn) {
                    nextBtn.textContent = originalText || 'â¡ï¸ æ ¹æ“šæˆ‘çš„æ—¥è¨˜èª¿æ•´éš”å¤©è¡Œç¨‹';
                    nextBtn.classList.remove('btn-loading');
                    nextBtn.classList.add('btn-done');
                    setTimeout(() => nextBtn.classList.remove('btn-done'), 300);
                }
            }
        }


        /**
         * æœ€çµ‚ AI åˆ†æåŠŸèƒ½
         */
        async function analyzeFinalMood() {
            const analyzeBtn = document.getElementById('analyze-mood-btn');
            const summaryDiv = document.getElementById('final-mood-summary');
            
            if (!fullItineraryData) {
                summaryDiv.innerHTML = '<p style="color:red;">è«‹å…ˆç”Ÿæˆè¡Œç¨‹ï¼</p>';
                return;
            }

            setButtonState('analyze-mood-btn', true, 'AI æ­£åœ¨åˆ†ææ‚¨çš„æƒ…ç·’è»Œè·¡...');
            summaryDiv.innerHTML = '<div class="loading">æ­£åœ¨æ•´åˆæ‚¨çš„æ¯æ—¥åé¥‹ï¼Œè«‹ç¨å€™...</div>';

            // æ”¶é›†æ‰€æœ‰ä½¿ç”¨è€…çš„åé¥‹
            const userFeedbacks = [];
            const dayPlans = fullItineraryData.days;
            
            dayPlans.forEach((dayPlan, index) => {
                const moodSelect = document.querySelector(`.day-mood-select[data-day-index="${index}"]`);
                const sentenceInput = document.querySelector(`.day-sentence-input[data-day-index="${index}"]`);
                const dayTitleEl = document.getElementById(`day-title-${index}`);
                const dayTitle = dayTitleEl ? dayTitleEl.textContent : `Day ${index+1}`;
                const savedLog = userDiaryLogs.find(x => x.dayIndex === index);
                const selectedMood = savedLog ? (savedLog.mood || 'æœªé¸æ“‡') : (moodSelect ? moodSelect.value : 'æœªé¸æ“‡');
                const inputSentence = savedLog ? (String(savedLog.sentence || '').trim() || 'ç„¡è¨˜éŒ„') : (sentenceInput ? (sentenceInput.value.trim() || 'ç„¡è¨˜éŒ„') : 'ç„¡è¨˜éŒ„');
                userFeedbacks.push({
                    day: dayTitle,
                    mood: selectedMood,
                    sentence: inputSentence,
                    ai_mood_note: dayPlan.items.map(item => item.mood_note).join('; ')
                });
            });

            // æº–å‚™ AI Prompt
            const moodTheme = document.getElementById('mood_theme').value.trim();
            const travelers = document.getElementById('travelers').value.trim();

            const prompt = `
            ä½ æ˜¯ä¸€ä½æƒ…ç·’æ—…éŠåˆ†æå¸«ã€‚ä¸»é¡Œã€Œ${moodTheme}ã€ï¼ŒåŒè¡Œ ${travelers} äººã€‚
            ä»¥ä¸‹æ˜¯æ¯æ—¥çš„æƒ…ç·’èˆ‡ä¸€å¥è©±ï¼Œå« AI çš„æƒ…ç·’å‚™è¨»ï¼š
            ${userFeedbacks.map(f => `[${f.day}] æ„Ÿå—ï¼š${f.mood}ï¼›ä¸€å¥è©±ï¼šã€Œ${f.sentence}ã€ã€‚AIå‚™è¨»ï¼š${f.ai_mood_note}`).join('\n')}
            è«‹ä»¥æ¥µç²¾ç°¡çš„ 3 æ®µè½è¼¸å‡ºï¼ˆç¸½é•·åº¦ â‰¤ 120 å­—ï¼‰ï¼š
            1) æ•´é«”æƒ…ç·’èµ°å‹¢ä¸€å¥è©±
            2) é æœŸ vs å¯¦éš›ä¸€å¥è©±
            3) æœ€é‡è¦çš„æƒ…ç·’æ”¶ç©«ä¸€å¥è©±
            `;

            try {
                const response = await aiClient.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                    config: { temperature: 0.5 }
                });

                const shortText = (response.text || '').trim();
                summaryDiv.innerHTML = `
                    <h3>ğŸ’– æ‚¨çš„æ—…ç¨‹æƒ…ç·’ç¸½çµ</h3>
                    <div style="white-space: pre-wrap; margin-bottom:12px;">${shortText}</div>
                    <div id="final-feedback-form" style="background:#fff; border:1px solid #eee; border-radius:8px; padding:12px;">
                        <div style="font-weight:700; margin-bottom:8px;">æˆ‘çš„æ—…éŠå›é¥‹ï¼ˆç°¡çŸ­ä¸€å¥è©±ï¼‰</div>
                        <div style="display:grid; grid-template-columns: 1fr; gap:8px;">
                            <label>æœ€é–‹å¿ƒ <input type="text" id="ff-best" placeholder="ä¾‹å¦‚ï¼šåœ¨å±•æœ›å°çœ‹å¤œæ™¯è¶…å¹¸ç¦"></label>
                            <label>è¨˜æ†¶æ·±åˆ» <input type="text" id="ff-memorable" placeholder="ä¾‹å¦‚ï¼šåœ¨åœ°å¸‚å ´çš„äº’å‹•å¾ˆæº«æš–"></label>
                            <label>æœ€ä¸é–‹å¿ƒ <input type="text" id="ff-worst" placeholder="ä¾‹å¦‚ï¼šäº¤é€šè½‰ä¹˜å¤ªæ··äº‚å¾ˆç´¯"></label>
                        </div>
                        <div style="margin-top:10px;">
                            <button id="btn-next-reco" class="tools-btn">âœ¨ ç”Ÿæˆä¸‹æ¬¡æ—…éŠå»ºè­°</button>
                        </div>
                        <div id="next-reco-output" class="summary" style="margin-top:10px; display:none;"></div>
                    </div>
                `;

            } catch (error) {
                console.error("æœ€çµ‚æƒ…ç·’åˆ†æå¤±æ•—:", error);
                summaryDiv.innerHTML = '<p style="color:red;">æœ€çµ‚æƒ…ç·’åˆ†æå¤±æ•—ã€‚è«‹æª¢æŸ¥ Key ç‹€æ…‹æˆ–ç¶²è·¯é€£ç·šã€‚</p>';
            } finally {
                setButtonState('analyze-mood-btn', false, 'ğŸ’¡ é»æ“Šï¼šç¸½çµæˆ‘çš„æ—…ç¨‹æƒ…ç·’èˆ‡åƒ¹å€¼å›é¥‹');
            }
        }
        async function analyzeFinalMoodFromSaved() {
            const targetId = 'scheduler-final-summary-content';
            const summaryDiv = document.getElementById(targetId);
            if (!summaryDiv) return;
            if (!fullItineraryData || !fullItineraryData.days || fullItineraryData.days.length === 0) {
                summaryDiv.innerHTML = '<p style="color:red;">è«‹å…ˆç”Ÿæˆä¸¦ç¢ºèªè¡Œç¨‹ï¼</p>';
                return;
            }
            if (!userDiaryLogs || userDiaryLogs.length === 0) {
                summaryDiv.innerHTML = '<p style="color:red;">è«‹å…ˆæ–¼æ¯ä¸€å¤©æŒ‰ä¸‹ã€ŒğŸ“ å„²å­˜ä»Šæ—¥æ—¥è¨˜ã€ã€‚</p>';
                return;
            }
            const btn = document.getElementById('btn-scheduler-analyze');
            if (btn) setButtonState('btn-scheduler-analyze', true, 'åˆ†æä¸­...');
            summaryDiv.innerHTML = '<div class="loading">æ­£åœ¨æ•´åˆæ‚¨å·²å„²å­˜çš„æ¯æ—¥æ—¥è¨˜ï¼Œè«‹ç¨å€™...</div>';
            const dayPlans = fullItineraryData.days;
            const userFeedbacks = userDiaryLogs
                .sort((a,b)=>a.dayIndex-b.dayIndex)
                .map(log => {
                    const dp = dayPlans[log.dayIndex];
                    const dayTitle = dp ? (dp.day + ' - ' + dp.date) : (`Day ${log.dayIndex+1}`);
                    return {
                        day: dayTitle,
                        mood: log.mood || 'æœªé¸æ“‡',
                        sentence: (String(log.sentence || '').trim() || 'ç„¡è¨˜éŒ„'),
                        ai_mood_note: (dp && dp.items ? dp.items.map(it => it.mood_note).join('; ') : '')
                    };
                });
            const moodTheme = document.getElementById('mood_theme').value.trim();
            const travelers = document.getElementById('travelers').value.trim();
            const prompt = `
            ä½ æ˜¯ä¸€ä½æƒ…ç·’æ—…éŠåˆ†æå¸«ã€‚ä¸»é¡Œã€Œ${moodTheme}ã€ï¼ŒåŒè¡Œ ${travelers} äººã€‚
            ä»¥ä¸‹æ˜¯ä½¿ç”¨è€…ã€Œå·²å„²å­˜ã€çš„æ¯æ—¥å¿ƒæƒ…èˆ‡ä¸€å¥è©±ï¼ˆå« AI çš„æƒ…ç·’å‚™è¨»ï¼‰ï¼š
            ${userFeedbacks.map(f => `[${f.day}] æ„Ÿå—ï¼š${f.mood}ï¼›ä¸€å¥è©±ï¼šã€Œ${f.sentence}ã€ã€‚AIå‚™è¨»ï¼š${f.ai_mood_note}`).join('\n')}
            è«‹ä»¥æ¥µç²¾ç°¡çš„ 3 æ®µè½è¼¸å‡ºï¼ˆç¸½é•·åº¦ â‰¤ 120 å­—ï¼‰ï¼š
            1) æ•´é«”æƒ…ç·’èµ°å‹¢ä¸€å¥è©±
            2) é æœŸ vs å¯¦éš›ä¸€å¥è©±
            3) æœ€é‡è¦çš„æƒ…ç·’æ”¶ç©«ä¸€å¥è©±
            `;
            try {
                const response = await aiClient.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                    config: { temperature: 0.5 }
                });
                const shortText = (response.text || '').trim();
                summaryDiv.innerHTML = `
                    <h3>ğŸ’– æ‚¨çš„æ—…ç¨‹æƒ…ç·’ç¸½çµ</h3>
                    <div style="white-space: pre-wrap; margin-bottom:12px;">${shortText}</div>
                    <div id="final-feedback-form" style="background:#fff; border:1px solid #eee; border-radius:8px; padding:12px;">
                        <div style="font-weight:700; margin-bottom:8px;">æˆ‘çš„æ—…éŠå›é¥‹ï¼ˆç°¡çŸ­ä¸€å¥è©±ï¼‰</div>
                        <div style="display:grid; grid-template-columns: 1fr; gap:8px;">
                            <label>æœ€é–‹å¿ƒ <input type="text" id="ff-best" placeholder="ä¾‹å¦‚ï¼šåœ¨å±•æœ›å°çœ‹å¤œæ™¯è¶…å¹¸ç¦"></label>
                            <label>è¨˜æ†¶æ·±åˆ» <input type="text" id="ff-memorable" placeholder="ä¾‹å¦‚ï¼šåœ¨åœ°å¸‚å ´çš„äº’å‹•å¾ˆæº«æš–"></label>
                            <label>æœ€ä¸é–‹å¿ƒ <input type="text" id="ff-worst" placeholder="ä¾‹å¦‚ï¼šäº¤é€šè½‰ä¹˜å¤ªæ··äº‚å¾ˆç´¯"></label>
                        </div>
                        <div style="margin-top:10px;">
                            <button id="btn-next-reco" class="tools-btn">âœ¨ ç”Ÿæˆä¸‹æ¬¡æ—…éŠå»ºè­°</button>
                        </div>
                        <div id="next-reco-output" class="summary" style="margin-top:10px; display:none;"></div>
                    </div>
                `;
            } catch (error) {
                summaryDiv.innerHTML = '<p style="color:red;">æœ€çµ‚æƒ…ç·’åˆ†æå¤±æ•—ã€‚è«‹æª¢æŸ¥ Key ç‹€æ…‹æˆ–ç¶²è·¯é€£ç·šã€‚</p>';
            } finally {
                if (btn) setButtonState('btn-scheduler-analyze', false, 'ğŸ’¡ ç¸½çµæˆ‘çš„æ—…ç¨‹æƒ…ç·’èˆ‡åƒ¹å€¼å›é¥‹');
            }
        }
        async function recommendNextTrip() {
            const out = document.getElementById('next-reco-output');
            if (!out) return;
            const best = (document.getElementById('ff-best')?.value || '').trim();
            const mem = (document.getElementById('ff-memorable')?.value || '').trim();
            const worst = (document.getElementById('ff-worst')?.value || '').trim();
            const btn = document.getElementById('btn-next-reco');
            if (btn) setButtonState('btn-next-reco', true, 'ç”Ÿæˆä¸­...');
            out.style.display = 'block';
            out.textContent = 'AI æ­£åœ¨æ ¹æ“šæ‚¨çš„å›é¥‹ç”Ÿæˆå»ºè­°â€¦';
            try {
                const userFeedbacks = [];
                const dayPlans = (fullItineraryData && fullItineraryData.days) ? fullItineraryData.days : [];
                dayPlans.forEach((dayPlan, index) => {
                    const savedLog = userDiaryLogs.find(x => x.dayIndex === index);
                    const moodSelect = document.querySelector(`.day-mood-select[data-day-index="${index}"]`);
                    const mood = savedLog ? (savedLog.mood || 'æœªé¸æ“‡') : (moodSelect ? moodSelect.value : 'æœªé¸æ“‡');
                    const sentenceInput = document.querySelector(`.day-sentence-input[data-day-index="${index}"]`);
                    const sentence = savedLog ? (String(savedLog.sentence || '').trim() || 'ç„¡è¨˜éŒ„') : (sentenceInput ? (sentenceInput.value.trim() || 'ç„¡è¨˜éŒ„') : 'ç„¡è¨˜éŒ„');
                    userFeedbacks.push({
                        mood,
                        sentence,
                        ai_mood_note: (dayPlan.items || []).map(item => item.mood_note).join('; ')
                    });
                });
                const preferTypes = {};
                dayPlans.forEach(dp => (dp.items || []).forEach(it => {
                    const t = String(it.type || '').trim();
                    if (!t) return;
                    preferTypes[t] = (preferTypes[t] || 0) + 1;
                }));
                const topTypes = Object.entries(preferTypes).sort((a,b)=>b[1]-a[1]).slice(0,2).map(x=>x[0]).join('ã€') || 'ï¼ˆç„¡ï¼‰';
                const prompt = `
                æˆ‘æƒ³è¦ä¸€å€‹éå¸¸ç²¾ç°¡çš„å»ºè­°ï¼ˆâ‰¤ 120 å­—ï¼Œä½¿ç”¨ä¸­æ–‡ï¼‰ï¼š
                æˆ‘çš„æ¯æ—¥æƒ…ç·’ï¼š${userFeedbacks.map(f=>`${f.mood}/${f.sentence}`).join('ï¼›')}
                AI çš„è¨˜æ†¶é‡é»ï¼ˆai_mood_noteï¼‰ï¼š${userFeedbacks.map(f=>f.ai_mood_note).join('ï¼›')}
                æˆ‘è‡ªå·±ç¸½çµï¼šæœ€é–‹å¿ƒã€Œ${best||'æœªå¡«'}ã€ã€è¨˜æ†¶æ·±åˆ»ã€Œ${mem||'æœªå¡«'}ã€ã€æœ€ä¸é–‹å¿ƒã€Œ${worst||'æœªå¡«'}ã€
                æœ¬æ¬¡å¸¸è¦‹é …ç›®é¡å‹ï¼š${topTypes}
                è«‹è¼¸å‡ºï¼š
                - ä¸€å¥ç°¡çŸ­çµè«–
                - æ¨è–¦ä¸‹æ¬¡æ—…éŠä¸»é¡Œ 1 å€‹ï¼ˆä¾‹å¦‚ï¼šç™‚ç™’ã€æ–‡åŒ–ã€ç¾é£Ÿã€è‡ªç„¶ã€æµªæ¼«ï¼‰
                - æ¨è–¦ä¸‹æ¬¡åœ‹å®¶/åŸå¸‚ 1 å€‹ï¼ˆåªåˆ—åç¨±ï¼‰
                - ä¸‰å€‹å…·é«”è¡Œç¨‹å»ºè­°ï¼ˆåˆ—é»ï¼‰
                ä¸è¦ä½¿ç”¨ JSONã€‚
                `;
                const response = await aiClient.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                    config: { temperature: 0.6 }
                });
                out.textContent = (response.text || '').trim();
            } catch (e) {
                out.textContent = 'ç”Ÿæˆå»ºè­°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
            } finally {
                if (btn) setButtonState('btn-next-reco', false, 'âœ¨ ç”Ÿæˆä¸‹æ¬¡æ—…éŠå»ºè­°');
            }
        }

        function renderPreviewControls() {
            return `
                <div style="display:flex; gap:10px; margin-top:12px;">
                    <button id="btn-preview-revise" class="tools-btn">ğŸ›  æˆ‘è¦ä¿®æ”¹æ•´é«”è¨ˆç•«</button>
                    <button id="btn-preview-confirm" class="tools-btn">âœ… ç¢ºèªè¡Œç¨‹ä¸¦é–‹å§‹æ’ç¨‹</button>
                </div>
            `;
        }

        async function generateFullItineraryPreview(revisionNote = '') {
            const destination = document.getElementById('destination').value.trim();
            const duration = parseInt(document.getElementById('duration').value.trim(), 10) || 1;
            const travelers = document.getElementById('travelers').value.trim();
            const budget = document.getElementById('budget').value;
            const transport = document.getElementById('transport').value;
            const moodTheme = document.getElementById('mood_theme').value.trim();
            const currentMood = document.getElementById('current_mood').value;
            const interests = document.getElementById('interests').value.trim();
            const outputDiv = document.getElementById('itinerary-output');
            const analyzeBtn = document.getElementById('analyze-mood-btn');
            
            if (!isKeyValid || !aiClient) {
                outputDiv.innerHTML = "<p style='color:red;'>è«‹å…ˆé©—è­‰æ‚¨çš„ Gemini API Keyã€‚</p>";
                return;
            }
            if (!destination || !duration || !travelers || !moodTheme) {
                outputDiv.innerHTML = "<p style='color:red;'>è«‹è¼¸å…¥æ—…éŠåœ°å€ã€å¤©æ•¸ã€äººæ•¸å’Œæ—…éŠä¸»é¡Œã€‚</p>";
                return;
            }
            const startDt = computeStartDate();
            if (!startDt) {
                outputDiv.innerHTML = "<p style='color:red;'>è«‹é¸æ“‡é–‹å§‹æ—¥æœŸã€‚</p>";
                return;
            }
            itineraryStartDate = startDt;
            const startDateStr = formatDate(startDt);

            setButtonState('generate-btn', true, 'ç”Ÿæˆä¸­...');
            if (analyzeBtn) analyzeBtn.style.display = 'none';
            document.getElementById('final-mood-summary').innerHTML = '';
            outputDiv.innerHTML = "<div class='loading'>æ­£åœ¨ä¸€æ¬¡ç”Ÿæˆå®Œæ•´è¡Œç¨‹é è¦½ï¼Œè«‹ç¨å€™...</div>";
            visitedLocations = new Set();
            visitedDescriptions = new Set();

            try {
                applyMoodTheme(moodTheme);
                const days = [];
                // Day 1
                {
                    const prompt = `
                    ä½ æ˜¯ä¸€ä½å°ˆæ³¨æ–¼ã€Œå€‹äººåŒ–æƒ…ç·’åƒ¹å€¼ã€çš„æ—…éŠè¦åŠƒå¸«ã€‚è«‹åªè¼¸å‡ºç¬¦åˆ Schema çš„ JSONã€‚
                    åœ°é»ï¼š${destination}
                    åŒè¡Œäººæ•¸ï¼š${travelers}
                    é ç®—ï¼š${budget}
                    äº¤é€šæ–¹å¼ï¼š${transport}
                    ä¸»é¡Œï¼š${moodTheme}
                    ä½¿ç”¨è€…ç¾åœ¨å¿ƒæƒ…ï¼š${currentMood}
                    é¡å¤–éœ€æ±‚ï¼š${interests || 'ç„¡'}
                    ç¬¬ä¸€æ—¥æ—¥æœŸï¼š${startDateStr}
                    ${revisionNote ? `æ•´é«”èª¿æ•´éœ€æ±‚ï¼š${revisionNote}` : ''}
                    è«‹ç”Ÿæˆã€Œå–®ä¸€å¤©ã€çš„è©³ç´°è¡Œç¨‹ï¼Œæ™‚é–“é€£è²«ã€å…·é«”åœ°é»èˆ‡å¯¦éš›è²»ç”¨ä¼°è¨ˆï¼Œä¿ç•™æƒ…æ„Ÿå‚™è¨»ã€‚
                    `;
                    const response = await callModelJSON(DAY_SCHEMA, prompt, 0.75);
                    const dayPlan = JSON.parse(response.text);
                    dayPlan.day = dayPlan.day || 'Day 1';
                    dayPlan.date = startDateStr;
                    days.push(dayPlan);
                    collectVisited(dayPlan.items);
                }
                // Day 2..N
                for (let i = 1; i < duration; i++) {
                    const computedDate = formatDate(addDays(itineraryStartDate, i));
                    const prompt = `
                    è«‹ç”Ÿæˆç¬¬ ${i+1} å¤©çš„è©³ç´°è¡Œç¨‹ã€‚åªè¼¸å‡º JSONï¼Œéµå®ˆ Schemaã€‚
                    åœ°é»ï¼š${destination}
                    åŒè¡Œäººæ•¸ï¼š${travelers}
                    é ç®—ï¼š${budget}
                    äº¤é€šæ–¹å¼ï¼š${transport}
                    ä¸»é¡Œï¼š${moodTheme}
                    é¡å¤–éœ€æ±‚ï¼š${interests || 'ç„¡'}
                    ${revisionNote ? `æ•´é«”èª¿æ•´éœ€æ±‚ï¼š${revisionNote}` : ''}
                    ç•¶æ—¥æ—¥æœŸï¼š${computedDate}
                    é¿å…é‡è¤‡ä»¥ä¸‹åœ°é»ï¼š${Array.from(visitedLocations).join(', ') || 'ï¼ˆç„¡ï¼‰'}
                    é¿å…é‡è¤‡ä»¥ä¸‹é …ç›®ï¼š${Array.from(visitedDescriptions).join(', ') || 'ï¼ˆç„¡ï¼‰'}
                    è¦æ±‚ï¼šæ´»å‹•å®‰æ’éœ€å‘¼æ‡‰ä¸»é¡Œèˆ‡åå¥½ï¼Œå…·é«”åœ°é»èˆ‡è²»ç”¨ä¼°è¨ˆï¼Œç¦æ­¢èˆ‡å‰å¹¾å¤©å…§å®¹é‡è¤‡ã€‚
                    `;
                    const response = await callModelJSON(DAY_SCHEMA, prompt, 0.7);
                    const dayPlan = JSON.parse(response.text);
                    dayPlan.day = dayPlan.day || `Day ${i+1}`;
                    dayPlan.date = computedDate;
                    days.push(dayPlan);
                    collectVisited(dayPlan.items);
                    await new Promise(res => setTimeout(res, 600));
                }
                fullItineraryData = { days };
                let html = `<h2>ğŸ—ºï¸ ${destination} ${duration} å¤©é è¦½ï¼ˆä¸»é¡Œï¼š${moodTheme}ï¼‰</h2>`;
                days.forEach((dayPlan, idx) => {
                    let totalCost = 0;
                    let dailyHtml = '';
                    dayPlan.items.forEach(item => {
                        const costValue = parseInt(item.cost) || 0;
                        totalCost += costValue;
                        const mapLink = generateMapEmbedUrl(item.location);
                        const imageLink = generateImageSearchUrl(item.location);
                        dailyHtml += `
                            <tr>
                                <td class="time-col">${item.time}</td>
                                <td class="duration-col">
                                    æ´»å‹•: ${item.duration_activity}<br>
                                    <span style="color:#d32f2f;">äº¤é€š: ${item.duration_travel}</span>
                                </td>
                                <td class="item-col">
                                    <span class="chip">${item.type}</span> ${item.description}<br>
                                    <div class="mood-note">âœ¨ **æƒ…æ„Ÿå‚™è¨»ï¼š** ${item.mood_note}</div>
                                    <div class="note-intro">**ä»‹ç´¹ï¼š** ${item.intro}</div>
                                    <small>åœ°é»ï¼š${item.location}</small>
                                    <a class="image-btn" href="${imageLink}" target="_blank" title="é»æ“ŠæŸ¥çœ‹è©²åœ°é»çš„åœ–ç‰‡">ğŸ“¸ åœ–ç‰‡åƒè€ƒ</a>
                                </td>
                                <td class="transport-col">${item.transport}</td>
                                <td class="cost-col">$${costValue}</td>
                            </tr>
                            <tr>
                                <td colspan="5" style="padding-top: 0;">
                                    <div class="map-container">
                                        <iframe class="map-iframe" loading="lazy" src="${mapLink}" allowfullscreen></iframe>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    html += `
                        <div class="day-plan">
                            <h3 id="day-title-${idx}">${dayPlan.day} - ${dayPlan.date}</h3>
                            <div class="table-wrapper">
                                <table class="itinerary-table">
                                    <thead>
                                        <tr>
                                            <th class="time-col">é–‹å§‹æ™‚é–“</th>
                                            <th class="duration-col">é ä¼°æ™‚é•·</th>
                                            <th class="item-col">é …ç›® (é¡å‹/æƒ…ç·’)</th>
                                            <th class="transport-col">äº¤é€š</th>
                                            <th class="cost-col">é ä¼°é‡‘é¡ (TWD)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${dailyHtml}
                                    </tbody>
                                </table>
                            </div>
                            <div class="summary">ç•¶æ—¥ç¸½é ä¼°èŠ±è²»ï¼š$${totalCost} TWD</div>
                        </div>
                    `;
                });
                html += renderPreviewControls();
                outputDiv.innerHTML = html;
                const tb = document.getElementById('tools-bar');
                if (tb) tb.style.display = 'flex';
                renderDestinationCards();
            } catch (error) {
                console.error("ç”Ÿæˆå®Œæ•´é è¦½æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                if (/RESOURCE_EXHAUSTED|429|quota|rate|UNAVAILABLE|503/i.test(String(error.message || ''))) {
                    showRateLimitNotice(error.message || '');
                } else {
                    let errorMsg = error.message.includes('Unexpected token') || error.message.includes('JSON') ?
                        'è¡Œç¨‹ç”Ÿæˆå¤±æ•—ã€‚AI å›å‚³çš„ JSON æ ¼å¼ä¸æ­£ç¢ºã€‚è«‹å˜—è©¦ç°¡åŒ–æ‚¨çš„éœ€æ±‚æˆ–æª¢æŸ¥ Key ç‹€æ…‹ã€‚' :
                        `è¡Œç¨‹ç”Ÿæˆå¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯ï¼š${error.message}`;
                    outputDiv.innerHTML = `<p style='color:red;'>${errorMsg}</p>`;
                }
            } finally {
                setButtonState('generate-btn', false, 'ğŸ’– ç‚ºæˆ‘ç”Ÿæˆå°ˆå±¬è¡Œç¨‹');
            }
        }

        function startScheduler() {
            const destination = document.getElementById('destination').value.trim();
            const moodTheme = document.getElementById('mood_theme').value.trim();
            if (!fullItineraryData || !fullItineraryData.days || fullItineraryData.days.length === 0) {
                switchPage('page-planner');
                return;
            }
            switchPage('page-scheduler');
            const sched = document.getElementById('scheduler-output');
            let html = `<h2>ğŸ”§ å·²ç¢ºèªçš„ ${destination} è¡Œç¨‹ï¼ˆ${moodTheme}ï¼‰</h2>`;
            fullItineraryData.days.forEach((dayPlan, idx) => {
                let totalCost = 0;
                let dailyHtml = '';
                dayPlan.items.forEach(item => {
                    const costValue = parseInt(item.cost) || 0;
                    totalCost += costValue;
                    const mapLink = generateMapEmbedUrl(item.location);
                    const imageLink = generateImageSearchUrl(item.location);
                    dailyHtml += `
                        <tr>
                            <td class="time-col">${item.time}</td>
                            <td class="duration-col">
                                æ´»å‹•: ${item.duration_activity}<br>
                                <span style="color:#d32f2f;">äº¤é€š: ${item.duration_travel}</span>
                            </td>
                            <td class="item-col">
                                <span class="chip">${item.type}</span> ${item.description}<br>
                                <div class="mood-note">âœ¨ **æƒ…æ„Ÿå‚™è¨»ï¼š** ${item.mood_note}</div>
                                <div class="note-intro">**ä»‹ç´¹ï¼š** ${item.intro}</div>
                                <small>åœ°é»ï¼š${item.location}</small>
                                <a class="image-btn" href="${imageLink}" target="_blank" title="é»æ“ŠæŸ¥çœ‹è©²åœ°é»çš„åœ–ç‰‡">ğŸ“¸ åœ–ç‰‡åƒè€ƒ</a>
                            </td>
                            <td class="transport-col">${item.transport}</td>
                            <td class="cost-col">$${costValue}</td>
                        </tr>
                        <tr>
                            <td colspan="5" style="padding-top: 0;">
                                <div class="map-container">
                                    <iframe class="map-iframe" loading="lazy" src="${mapLink}" allowfullscreen></iframe>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                html += `
                    <div class="day-plan" id="day-plan-${idx}">
                        <h3 id="day-title-${idx}">${dayPlan.day} - ${dayPlan.date}</h3>
                        <div class="table-wrapper">
                            <table class="itinerary-table">
                                <thead>
                                    <tr>
                                        <th class="time-col">é–‹å§‹æ™‚é–“</th>
                                        <th class="duration-col">é ä¼°æ™‚é•·</th>
                                        <th class="item-col">é …ç›® (é¡å‹/æƒ…ç·’)</th>
                                        <th class="transport-col">äº¤é€š</th>
                                        <th class="cost-col">é ä¼°é‡‘é¡ (TWD)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${dailyHtml}
                                </tbody>
                            </table>
                        </div>
                        <div class="summary">ç•¶æ—¥ç¸½é ä¼°èŠ±è²»ï¼š$${totalCost} TWD</div>
                        <div class="feedback-container" data-day-index="${idx}">
                            <div>
                                <label for="mood-select-${idx}">ä»Šæ—¥æ„Ÿå—ï¼š</label>
                                ${generateMoodSelect(idx)}
                            </div>
                            <div>
                                <label for="sentence-input-${idx}">ä¸€å¥è©±è¨˜éŒ„ï¼š</label>
                                <input type="text" id="sentence-input-${idx}" placeholder="ç°¡çŸ­ç´€éŒ„ç•¶æ—¥æ„Ÿå—" class="day-sentence-input" data-day-index="${idx}">
                            </div>
                        </div>
                        <div style="margin-top:8px; display:flex; gap:8px;">
                            <button class="tools-btn btn-save-diary" data-day-index="${idx}">ğŸ“ å„²å­˜ä»Šæ—¥æ—¥è¨˜</button>
                            <button class="next-day-btn" data-prev-day-index="${idx}">â¡ï¸ æ ¹æ“šæˆ‘çš„æ—¥è¨˜èª¿æ•´éš”å¤©è¡Œç¨‹</button>
                        </div>
                    </div>
                `;
            });
            html += `
                <div class="day-plan" id="scheduler-final-summary">
                    <div class="summary">æ—…ç¨‹å®Œæˆå¾Œæ–¼æ­¤é€²è¡Œç¸½çµï¼Œåƒ…ä½¿ç”¨æ‚¨ã€Œå·²å„²å­˜ã€çš„æ¯æ—¥æ—¥è¨˜ã€‚</div>
                    <button id="btn-scheduler-analyze" class="tools-btn">ğŸ’¡ ç¸½çµæˆ‘çš„æ—…ç¨‹æƒ…ç·’èˆ‡åƒ¹å€¼å›é¥‹</button>
                    <div id="scheduler-final-summary-content" style="margin-top:10px;"></div>
                </div>
            `;
            sched.innerHTML = html;
            const analyzeBtn = document.getElementById('analyze-mood-btn');
            if (analyzeBtn) analyzeBtn.style.display = 'none';
        }

        function initApp() {
            const safeBind = (id, type, handler) => {
                const el = document.getElementById(id);
                if (el) el.addEventListener(type, handler);
            };
            safeBind('validate-btn', 'click', validateKey);
            safeBind('generate-btn', 'click', () => generateFullItineraryPreview(''));
            safeBind('analyze-mood-btn', 'click', analyzeFinalMood);
            const outputDiv = document.getElementById('itinerary-output');
            if (outputDiv) {
                outputDiv.addEventListener('click', (e) => {
                    const reviseBtn = safeClosestFromEvent(e, '#btn-preview-revise');
                    if (reviseBtn) {
                        const wrapId = 'preview-revise-wrap';
                        let wrap = document.getElementById(wrapId);
                        if (!wrap) {
                            const el = document.createElement('div');
                            el.id = wrapId;
                            el.innerHTML = `
                                <div style="margin-top:10px;">
                                    <textarea id="preview-revise-input" rows="3" style="width:100%;" placeholder="èªªæ˜å¸Œæœ›èª¿æ•´çš„æ–¹å‘ï¼ˆä¾‹å¦‚ï¼šé™ä½é ç®—ã€å¢åŠ è‡ªç„¶æ™¯é»ã€åˆªæ‰è³¼ç‰©ï¼‰ã€"></textarea>
                                    <button id="btn-preview-apply" class="tools-btn" style="margin-top:8px;">å¥—ç”¨èª¿æ•´ä¸¦é‡æ–°ç”Ÿæˆ</button>
                                </div>
                            `;
                            outputDiv.appendChild(el);
                        } else {
                            wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
                        }
                    }
                    const applyBtn = safeClosestFromEvent(e, '#btn-preview-apply');
                    if (applyBtn) {
                        const noteEl = document.getElementById('preview-revise-input');
                        const note = noteEl ? noteEl.value.trim() : '';
                        generateFullItineraryPreview(note);
                    }
                    const confirmBtn = safeClosestFromEvent(e, '#btn-preview-confirm');
                    if (confirmBtn) {
                        startScheduler();
                    }
                    const lite = safeClosestFromEvent(e, '#rate-switch-lite');
                    if (lite) {
                        CURRENT_MODEL = 'gemini-2.5-flash-lite';
                        if (!fullItineraryData || !fullItineraryData.days || fullItineraryData.days.length === 0) {
                            generateItinerary();
                        } else {
                            const prevDayIndex = fullItineraryData.days.length - 1;
                            generateNextDay(prevDayIndex);
                        }
                    }
                });
            }
            const sched = document.getElementById('scheduler-output');
            if (sched) {
                sched.addEventListener('click', (e) => {
                    const btn = safeClosestFromEvent(e, '.next-day-btn');
                    if (btn && btn.dataset.prevDayIndex) {
                        const prevDayIndex = parseInt(btn.dataset.prevDayIndex);
                        if (!isNaN(prevDayIndex)) {
                            e.stopPropagation();
                            generateNextDay(prevDayIndex);
                        }
                    }
                    const saveBtn = safeClosestFromEvent(e, '.btn-save-diary');
                    if (saveBtn && saveBtn.dataset.dayIndex) {
                        const di = parseInt(saveBtn.dataset.dayIndex, 10);
                        if (!isNaN(di)) {
                            e.stopPropagation();
                            saveDiaryForDay(di, sched);
                        }
                    }
                    const sumBtn = safeClosestFromEvent(e, '#btn-scheduler-analyze');
                    if (sumBtn) {
                        e.stopPropagation();
                        analyzeFinalMoodFromSaved();
                    }
                });
            }
            safeBind('btn-export-json', 'click', exportItineraryJSON);
            safeBind('btn-export-ics', 'click', exportItineraryICS);
            safeBind('btn-copy-text', 'click', copyItineraryText);
            safeBind('btn-print', 'click', printItinerary);
            const assistantToggle = document.getElementById('assistant-toggle');
            if (assistantToggle) {
                assistantToggle.addEventListener('click', () => {
                    const panel = document.getElementById('assistant-panel');
                    if (panel) panel.classList.toggle('open');
                    renderFAQ(FAQ_DATA);
                    const ans = document.getElementById('assistant-ai-answer');
                    if (ans) ans.style.display = 'none';
                });
            }
            const assistantInput = document.getElementById('assistant-input');
            if (assistantInput) {
                assistantInput.addEventListener('input', (e) => {
                    const q = e.target.value;
                    renderFAQ(filterFAQ(q));
                });
                assistantInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        const q = e.target.value.trim();
                        if (q) askAssistant(q);
                    }
                });
            }
            safeBind('assistant-ask', 'click', () => {
                const aiInput = document.getElementById('assistant-input');
                const q = aiInput ? aiInput.value.trim() : '';
                if (q) askAssistant(q);
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const page = btn.dataset.page;
                    switchPage(page);
                    if (page === 'page-wheel') {
                        const wr = document.getElementById('wheel-region');
                        renderWheelOptions(wr ? wr.value : 'å…¨çƒ');
                    }
                    if (page === 'page-share') {
                        renderSharePosts();
                    }
                });
            });
            const wheelRegion = document.getElementById('wheel-region');
            if (wheelRegion) {
                wheelRegion.addEventListener('change', (e) => {
                    renderWheelOptions(e.target.value);
                });
            }
            safeBind('btn-spin', 'click', spinWheel);
            safeBind('btn-idea', 'click', rollIdea);
            safeBind('btn-mood-boost', 'click', moodBoost);
            safeBind('btn-apply-meter', 'click', applyMeterTheme);
            safeBind('btn-playlist', 'click', playPlaylist);
            safeBind('share-submit', 'click', handleShareSubmit);
            const wheelApply = document.getElementById('wheel-apply');
            if (wheelApply) {
                wheelApply.addEventListener('click', () => {
                    if (!lastWheelPick) return;
                    const dest = document.getElementById('destination');
                    if (dest) {
                        dest.value = lastWheelPick;
                        switchPage('page-planner');
                        dest.style.transform = 'scale(1.03)';
                        setTimeout(()=>dest.style.transform='scale(1)', 160);
                    }
                });
            }
            const keyInput = document.getElementById('key-input');
            if (keyInput) {
                keyInput.addEventListener('input', () => {
                    const current = keyInput.value.trim();
                    const genBtn = document.getElementById('generate-btn');
                    const ks = document.getElementById('key-status');
                    if (validatedApiKey && current === validatedApiKey) {
                        isKeyValid = true;
                        if (genBtn) genBtn.disabled = false;
                        if (ks) ks.innerHTML = `<span style="color:green; font-weight:bold;">âœ… Key é©—è­‰æˆåŠŸï¼</span>`;
                    } else {
                        isKeyValid = false;
                        if (genBtn) genBtn.disabled = true;
                        if (ks) ks.innerHTML = '';
                        if (outputDiv) outputDiv.innerHTML = '<p>è«‹é‡æ–°é©—è­‰æ‚¨çš„ Keyã€‚</p>';
                    }
                    const analyzeBtn = document.getElementById('analyze-mood-btn');
                    if (analyzeBtn) analyzeBtn.style.display = 'none';
                    const finalDiv = document.getElementById('final-mood-summary');
                    if (finalDiv) finalDiv.innerHTML = '';
                    const audio = document.getElementById('mood-audio');
                    if (audio) audio.pause();
                });
            }
            document.querySelectorAll('#input-fields input, #input-fields select, #mood_theme, #interests').forEach(input => {
                input.addEventListener('input', () => {
                    if (outputDiv) outputDiv.innerHTML = '<p>è«‹é»æ“ŠæŒ‰éˆ•ä¾†é‡æ–°è¦åŠƒã€‚</p>';
                    const analyzeBtn = document.getElementById('analyze-mood-btn');
                    if (analyzeBtn) analyzeBtn.style.display = 'none';
                    const finalDiv = document.getElementById('final-mood-summary');
                    if (finalDiv) finalDiv.innerHTML = '';
                });
            });
            document.addEventListener('pointerdown', (e) => {
                const btn = safeClosestFromEvent(e, 'button, .tools-btn, .next-day-btn, .tab-btn');
                if (btn) btn.classList.add('pressed');
            });
            document.addEventListener('pointerup', (e) => {
                const btn = safeClosestFromEvent(e, 'button, .tools-btn, .next-day-btn, .tab-btn');
                if (btn) btn.classList.remove('pressed');
            });
            document.addEventListener('pointerleave', (e) => {
                const btn = safeClosestFromEvent(e, 'button, .tools-btn, .next-day-btn, .tab-btn');
                if (btn) btn.classList.remove('pressed');
            });
            document.addEventListener('click', (e) => {
                const recoBtn = safeClosestFromEvent(e, '#btn-next-reco');
                if (recoBtn) {
                    e.stopPropagation();
                    recommendNextTrip();
                }
                const applySug = safeClosestFromEvent(e, '.wheel-apply-suggestion');
                if (applySug) {
                    e.stopPropagation();
                    const region = applySug.dataset.region || '';
                    const themes = applySug.dataset.themes || '';
                    applyThemeAndRegionToPlanner(region, themes);
                }
            });
            (function(){
                var mEl = document.getElementById('mood_theme');
                applyMoodTheme(mEl ? mEl.value : '');
                var wrEl = document.getElementById('wheel-region');
                renderWheelOptions(wrEl ? wrEl.value : 'å…¨çƒ');
                initShareBoard();
            })();
        }
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
