<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾ˆæœ‰SENSEå˜›~</title>
    <script type="module" src="https://esm.run/@google/genai"></script>
    <style>
        /* -------------------- è¦–è¦ºè¨­è¨ˆèˆ‡ RWD åŸºç¤ -------------------- */
        :root {
            /* é è¨­ä¸»é¡Œè‰² (æµªæ¼«ä¸»é¡Œ) */
            --main-color: #e91e63;
            --light-color: #ff80ab;
            --background-color: #fce4ec;
            --card-color: #fff8e1;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            background-color: var(--background-color); 
            color: #333;
            transition: background-color 0.8s ease; 
        }

        header {
            background-color: var(--main-color); 
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            margin-bottom: 25px;
            transition: background-color 0.8s ease;
        }
        
        h1 { margin: 0; font-size: 2.2em; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }

        #planner-form { 
            background-color: #ffffff; 
            padding: 30px; 
            border-radius: 15px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            margin-bottom: 30px; 
            border-top: 6px solid var(--light-color); 
            transition: border-top-color 0.8s ease;
        }
        
        /* è¡¨å–®ç¶²æ ¼ä½ˆå±€ */
        #input-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 15px 20px;
            margin-bottom: 20px;
        }

        /* è¼¸å…¥/é¸æ“‡æ¡†æ¨£å¼ */
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 12px; 
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 8px; 
            font-size: 1em;
            box-sizing: border-box;
        }
        input:focus, select:focus { border-color: var(--main-color); outline: none; box-shadow: 0 0 8px rgba(233, 30, 99, 0.5); }
        
        /* Key è¼¸å…¥å’Œç”ŸæˆæŒ‰éˆ•æ¨£å¼ */
        #key-input-group { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        #validate-btn { padding: 10px 15px; background-color: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #generate-btn { 
            width: 100%;
            padding: 18px 20px; 
            background-color: var(--main-color); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 1.3em;
            font-weight: bold;
            margin-top: 15px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: background-color 0.8s ease;
        }
        #generate-btn:hover { background-color: #c2185b; }
        #generate-btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; }
        
        /* è¼¸å‡ºçµæœæ¨£å¼ */
        #itinerary-output { background-color: #ffffff; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); overflow-x: auto; }
        .day-plan { background-color: var(--card-color); border: 1px solid var(--light-color); margin-bottom: 30px; padding: 20px; border-radius: 12px; transition: background-color 0.8s ease, border-color 0.8s ease; }
        .day-plan h3 { color: var(--main-color); border-bottom: 3px solid var(--light-color); padding-bottom: 5px; margin-top: 0; transition: color 0.8s ease, border-bottom-color 0.8s ease; }
        
        /* AI æ—…ä¼´èªæ°£å°èª */
        #ai-greeting {
            background-color: #e0f7fa;
            color: #00796b;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            font-size: 1.1em;
            font-style: italic;
            border-left: 5px solid #00bcd4;
        }

        /* è¡Œç¨‹æ°£æ°›åˆ†æ */
        #mood-analysis {
            margin-bottom: 25px;
            padding: 15px 20px;
            background-color: #f3e5f5;
            border-radius: 8px;
            font-weight: bold;
            border: 1px dashed #ce93d8;
        }
        #mood-analysis p { margin: 5px 0; }

        /* æƒ…ç·’å‚™è¨»æ¨£å¼ */
        .mood-note { 
            font-weight: bold; 
            color: #880e4f; 
            margin-top: 8px; 
            font-size: 0.95em; 
            padding: 6px 0;
            border-top: 1px dashed #f48fb1;
            white-space: normal;
        }

        /* æ–°å¢ï¼šæƒ…ç·’åé¥‹å€ (ä»£æ›¿æ—¥è¨˜æŒ‰éˆ•) */
        .feedback-container {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ccc;
            background-color: #fafafa;
            padding: 15px;
            border-radius: 8px;
        }
        .feedback-container label { font-weight: bold; margin-right: 10px; }
        .feedback-container input[type="text"] { 
            width: calc(100% - 140px); 
            display: inline-block;
            padding: 8px;
        }
        .feedback-container select { 
            width: 120px; 
            padding: 8px;
            display: inline-block;
        }
        .feedback-container div { margin-bottom: 10px; }

        /* æœ€çµ‚æƒ…ç·’ç¸½çµæŒ‰éˆ• */
        #analyze-mood-btn {
            width: 100%;
            padding: 15px;
            margin-top: 30px;
            background-color: #4db6ac; /* ç¶ æ¾çŸ³è‰² */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #analyze-mood-btn:hover { background-color: #26a69a; }
        #analyze-mood-btn:disabled { background-color: #ccc; cursor: not-allowed; }

        /* æœ€çµ‚æƒ…ç·’åˆ†æçµæœå€ */
        #final-mood-summary {
            margin-top: 20px;
            padding: 25px;
            background-color: #e8f5e9;
            border: 2px solid #aed581;
            border-radius: 10px;
            font-size: 1.1em;
            line-height: 1.6;
            white-space: pre-wrap; /* ä¿ç•™æ›è¡Œ */
        }

        .summary { margin-top: 20px; padding: 15px; background-color: #f8bbd0; border-left: 5px solid var(--main-color); font-weight: bold; color: #880e4f; border-radius: 6px; }
        .final-cost { color: var(--main-color); margin-top: 30px; padding: 15px; border: 2px dashed var(--light-color); border-radius: 8px; text-align: center; }

        /* è¡Œç¨‹è¡¨å„ªåŒ–å€å¡Š */
        .itinerary-table {
            width: 100%;
            border-collapse: collapse; /* ç§»é™¤è¡¨æ ¼çš„é‚Šç•Œé‡ç–Š */
            margin-top: 15px;
            table-layout: fixed; /* å›ºå®šåˆ—å¯¬ */
        }

        .itinerary-table th, .itinerary-table td {
            padding: 12px 8px; /* å¢åŠ å…§é‚Šè· */
            text-align: left;
            vertical-align: top;
            font-size: 0.95em;
        }

        .itinerary-table thead th {
            background-color: var(--light-color);
            color: white;
            font-weight: bold;
            border-bottom: 3px solid var(--main-color);
            position: sticky; /* è®“è¡¨é ­åœ¨æ»¾å‹•æ™‚å›ºå®š */
            top: 0;
        }
        
        /* å¢åŠ è¡Œç¨‹é …ç›®ä¹‹é–“çš„é–“éš”èˆ‡å€éš”ç·š */
        .itinerary-table tbody tr {
            /* é€™æ˜¯é—œéµçš„é–“éš”èˆ‡è¦–è¦ºå€éš” */
            border-bottom: 8px solid var(--card-color); /* æ¨¡æ“¬é–“è·çš„ç²—åº•ç·š */
            background-color: #ffffff; /* è®“é …ç›®åº•è‰²ç¨ç«‹æ–¼ day-plan */
            box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* è¼•å¾®é™°å½±å¢åŠ ç«‹é«”æ„Ÿ */
        }
        
        /* ç¬¬ä¸€å±¤ tr æ˜¯è¡Œç¨‹å…§å®¹ï¼Œç¬¬äºŒå±¤ tr æ˜¯åœ°åœ–ï¼Œæˆ‘å€‘åªå°è¡Œç¨‹å…§å®¹ tr å¢åŠ é–“éš”ï¼Œä¸”å°‡åœ°åœ– tr çš„èƒŒæ™¯è¨­ç‚ºå’Œ day-plan ä¸€æ¨£ */
        .itinerary-table tbody tr:nth-child(even) { /* åœ°åœ–é‚£è¡Œï¼Œå–æ¶ˆç™½åº• */
            background-color: var(--card-color);
            border-bottom: 0;
            padding-bottom: 0;
            box-shadow: none;
        }
        
        /* ç§»é™¤æœ€å¾Œä¸€ç­†è¡Œç¨‹çš„åº•éƒ¨é–“éš”ï¼Œè®“å®ƒçœ‹èµ·ä¾†æ›´å®Œæ•´ */
        .itinerary-table tbody tr:last-child {
            border-bottom: none;
        }
        
        /* é¿å…åœ°åœ–ä¸Šæ–¹çš„ tr è¢«åº•ç·šæ“‹ä½ï¼Œä½†é€™è£¡çš„çµæ§‹æ˜¯ tr+trï¼Œæ‰€ä»¥åªå°ç¬¬ä¸€å€‹ tr åšé–“éš”å°±å¥½ */
        .itinerary-table tbody tr:nth-child(odd) td {
            border-bottom: 1px solid #eee; /* ç´°ç·»çš„åˆ†éš”ç·š */
        }


        .time-col { width: 80px; font-weight: bold; }
        .duration-col { width: 100px; font-size: 0.85em; }
        .transport-col { width: 80px; }
        .cost-col { width: 100px; font-weight: bold; color: var(--main-color); }
        .item-col { width: auto; } /* è®“é …ç›®ä½”ç”¨å‰©é¤˜ç©ºé–“ */

        .note-intro {
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
            line-height: 1.4;
        }
        
        .image-btn {
            display: inline-block;
            margin-top: 5px;
            padding: 3px 8px;
            background-color: #ffe0b2;
            color: #e65100;
            border-radius: 4px;
            text-decoration: none;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        /* åœ°åœ–æ¨£å¼ */
        .map-container {
            width: 100%;
            height: 250px;
            margin-top: 10px;
            overflow: hidden;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .map-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }


        /* RWD å„ªåŒ– */
        @media (max-width: 900px) {
            .itinerary-table, .table-wrapper {
                display: block;
                overflow-x: auto;
                white-space: nowrap; /* é˜²æ­¢å…§å®¹æ›è¡Œï¼Œè®“è¡¨æ ¼å¯ä»¥æ°´å¹³æ²å‹• */
            }
            .itinerary-table {
                 min-width: 700px; /* ç¢ºä¿åœ¨å°è¢å¹•ä¸Šè‡³å°‘æœ‰ä¸€å®šå¯¬åº¦ */
            }
        }
        
        @media (max-width: 600px) {
            .feedback-container input[type="text"], .feedback-container select {
                width: 100%;
                margin-top: 5px;
            }
            .feedback-container input[type="text"] { margin-left: 0; }
        }
    </style>
</head>
<body>
    <audio id="mood-audio" loop></audio>

    <header>
        <h1>å¾ˆæœ‰SENSEå˜›~ğŸ’–AIæƒ…ç·’æ—…ä¼´è¦åŠƒ</h1>
    </header>
    
    <div class="container">
        <div id="planner-form">
            <div class="warning">
                **ğŸ”‘ Key æ³¨æ„ï¼šæ‚¨çš„ API Key æœƒåœ¨ç€è¦½å™¨ä¸­æš«å­˜ã€‚**
            </div>
            
            <label for="key-input" style="font-weight: bold;">Gemini API Keyï¼š</label>
            <div id="key-input-group">
                <input type="password" id="key-input" placeholder="è«‹åœ¨æ­¤è¼¸å…¥æ‚¨çš„ Gemini API Key">
                <button id="validate-btn">é©—è­‰ Key</button>
            </div>
            <div id="key-status"></div>

            <div id="input-fields">
                <div>
                    <label for="destination">æ—…éŠåœ°å€ (åœ‹å®¶/åŸå¸‚)ï¼š</label>
                    <input type="text" id="destination" placeholder="ä¾‹å¦‚ï¼šéŸ“åœ‹é¦–çˆ¾" value="æ±äº¬">
                </div>
                <div>
                    <label for="duration">æ—…éŠå¤©æ•¸ï¼š</label>
                    <input type="number" id="duration" min="1" max="14" value="3">
                </div>
                <div>
                    <label for="travelers">åŒè¡Œäººæ•¸ï¼š</label>
                    <input type="number" id="travelers" min="1" max="10" value="2">
                </div>
                <div>
                    <label for="budget">é ç®—ç­‰ç´šï¼š</label>
                    <select id="budget">
                        <option value="ç¶“æ¿Ÿ">ç¶“æ¿Ÿ</option>
                        <option value="ä¸­ç­‰" selected>ä¸­ç­‰</option>
                        <option value="å¥¢è¯">å¥¢è¯</option>
                    </select>
                </div>
                <div>
                    <label for="transport">ä¸»è¦äº¤é€šæ–¹å¼ï¼š</label>
                    <select id="transport">
                        <option value="å¤§çœ¾é‹è¼¸" selected>å¤§çœ¾é‹è¼¸</option>
                        <option value="ç§Ÿè»Š">ç§Ÿè»Šè‡ªé§•</option>
                        <option value="è¨ˆç¨‹è»Š/æ­¥è¡Œ">è¨ˆç¨‹è»Š/æ­¥è¡Œ</option>
                    </select>
                </div>
                <div>
                    <label for="current_mood">ç¾åœ¨çš„å¿ƒæƒ…å¦‚ä½•ï¼Ÿ</label>
                    <select id="current_mood">
                        <option value="æœŸå¾…" selected>ğŸ˜€ æœŸå¾…/èˆˆå¥®</option>
                        <option value="å¹³éœ">ğŸ˜Œ å¹³éœ/ç™‚ç™’</option>
                        <option value="ç–²æ†Š">ğŸ˜´ ç–²æ†Š/éœ€è¦æ”¾é¬†</option>
                        <option value="æ¢ç´¢">ğŸ§ æ¢ç´¢/å¥½å¥‡</option>
                        <option value="å­¤å–®">ğŸ˜¥ å­¤å–®/æƒ³è¢«é™ªä¼´</option>
                        <option value="é–‹å¿ƒ">ğŸ˜„ å¿«æ¨‚/æ´»åŠ›</option>
                    </select>
                </div>
            </div>

            <label for="mood_theme" style="font-weight: bold;">æ—…éŠä¸»é¡Œ/æƒ…å¢ƒ (å€‹äººåŒ–æƒ…ç·’é—œéµ)ï¼š</label>
            <input type="text" id="mood_theme" placeholder="ä¾‹å¦‚ï¼šå°‹æ±‚ç™‚ç™’æ”¾é¬†ã€æµªæ¼«æƒ…ä¾¶ä¹‹æ—…ã€ç¨è‡ªæ¢éšªæŒ‘æˆ°" value="æƒ…ä¾¶æµªæ¼«æ”¾é¬†">
            
            <label for="interests" style="font-weight: bold; margin-top: 10px; display: block;">é¡å¤–éœ€æ±‚/ç‰¹æ®Šèˆˆè¶£ï¼š</label>
            <input type="text" id="interests" placeholder="ä¾‹å¦‚ï¼šä¸»æ‰“å‹•æ¼«æ™¯é»ã€å¸Œæœ›çœ‹å¤œæ™¯" value="å¸Œæœ›å®‰æ’ä¸€å¤©ä¸‹åˆåœ¨ç‰¹è‰²å’–å•¡å»³æ”¾ç©º">


            <button id="generate-btn" disabled>ğŸ’– ç‚ºæˆ‘ç”Ÿæˆå°ˆå±¬è¡Œç¨‹</button>
        </div>

        <div id="itinerary-output">
            <p>è«‹è¼¸å…¥æ‚¨çš„é‡‘é‘°ä¸¦é»æ“Šã€Œé©—è­‰ Keyã€ã€‚</p>
        </div>
        
        <button id="analyze-mood-btn" style="display: none;">ğŸ’¡ é»æ“Šï¼šç¸½çµæˆ‘çš„æ—…ç¨‹æƒ…ç·’å›é¥‹</button>
        <div id="final-mood-summary"></div>
    </div>

    <script type="module">
        import { GoogleGenAI } from 'https://esm.run/@google/genai';
        
        let isKeyValid = false; 
        let aiClient; 
        let fullItineraryData = null; // å„²å­˜å®Œæ•´çš„è¡Œç¨‹æ•¸æ“šï¼Œä»¥ä¾¿æœ€çµ‚åˆ†æä½¿ç”¨
        
        // JSON Schema ä¿æŒä¸è®Š (å› ç‚ºåªéœ€è¦æå–æ•¸æ“š)
        const ITINERARY_SCHEMA = {
            type: "object",
            properties: {
                greeting: { type: "string" },
                mood_analysis: { type: "object", properties: { relax: { type: "string" }, romantic: { type: "string" }, explore: { type: "string" } } },
                days: {
                    type: "array",
                    items: {
                        type: "object",
                        properties: {
                            day: { type: "string" },
                            date: { type: "string" },
                            items: {
                                type: "array",
                                items: {
                                    type: "object",
                                    properties: {
                                        time: { type: "string" },
                                        description: { type: "string" },
                                        intro: { type: "string" }, 
                                        mood_note: { type: "string" },
                                        type: { type: "string", enum: ["æ™¯é»", "é¤é£Ÿ", "ä½å®¿", "æ´»å‹•"] },
                                        location: { type: "string" }, 
                                        transport: { type: "string" },
                                        duration_activity: { type: "string" },
                                        duration_travel: { type: "string" },
                                        cost: { type: "integer" }
                                    },
                                    required: ["time", "description", "intro", "mood_note", "type", "location", "transport", "duration_activity", "duration_travel", "cost"]
                                }
                            }
                        },
                        required: ["day", "date", "items"]
                    }
                }
            },
            required: ["greeting", "mood_analysis", "days"]
        };

        // æƒ…ç·’ä¸»é¡Œé…ç½®
        const MOOD_CONFIG = {
            'æµªæ¼«': { main_color: '#e91e63', light_color: '#ff80ab', background_color: '#fce4ec', card_color: '#fff8e1', audio_url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3' },
            'æ”¾é¬†': { main_color: '#388e3c', light_color: '#aed581', background_color: '#f1f8e9', card_color: '#e8f5e9', audio_url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3' },
            'æ¢ç´¢': { main_color: '#1a237e', light_color: '#7986cb', background_color: '#e8eaf6', card_color: '#e3f2fd', audio_url: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-5.mp3' },
            'default': { main_color: '#4CAF50', light_color: '#81c784', background_color: '#e8f5e9', card_color: '#f7fff7', audio_url: '' }
        };

        const MOOD_OPTIONS = [
            { value: "é–‹å¿ƒ", label: "ğŸ˜„ é–‹å¿ƒ" },
            { value: "ç™‚ç™’", label: "ğŸ˜Œ ç™‚ç™’" },
            { value: "ç–²æ†Š", label: "ğŸ˜´ ç–²æ†Š" },
            { value: "æ¢ç´¢", label: "ğŸ§ æ¢ç´¢" },
            { value: "æµªæ¼«", label: "ğŸ’ æµªæ¼«" },
            { value: "èˆˆå¥®", label: "ğŸ¤© èˆˆå¥®" },
            { value: "å­¤å–®", label: "ğŸ˜¥ å­¤å–®" },
            { value: "å¹³éœ", label: "ğŸ§˜ å¹³éœ" }
        ];

        function applyMoodTheme(moodTheme) {
            const themeKey = Object.keys(MOOD_CONFIG).find(key => moodTheme.includes(key)) || 'default';
            const config = MOOD_CONFIG[themeKey];
            const root = document.documentElement.style;
            const audio = document.getElementById('mood-audio');
            
            root.setProperty('--main-color', config.main_color);
            root.setProperty('--light-color', config.light_color);
            root.setProperty('--background-color', config.background_color);
            root.setProperty('--card-color', config.card_color);
            
            if (config.audio_url) {
                audio.src = config.audio_url;
                audio.volume = 0.3; 
                audio.play().catch(e => console.log("Audio playback blocked:", e)); 
            } else {
                audio.pause();
                audio.src = '';
            }
        }

        function setButtonState(btnId, isLoading, text) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            btn.textContent = text;
            btn.disabled = isLoading;
            
            if (btnId === 'generate-btn' && !isLoading) {
                btn.disabled = !isKeyValid;
            }
        }
        
        async function validateKey() {
            const geminiApiKey = document.getElementById('key-input').value.trim();
            
            const keyStatusDiv = document.getElementById('key-status');
            const generateBtn = document.getElementById('generate-btn');
            
            if (!geminiApiKey) {
                keyStatusDiv.innerHTML = `<span style="color:red;">è«‹è¼¸å…¥é‡‘é‘°ã€‚</span>`;
                isKeyValid = false;
                generateBtn.disabled = true;
                return;
            }

            setButtonState('validate-btn', true, 'é©—è­‰ä¸­...');
            keyStatusDiv.innerHTML = `<span style="color:#007bff;">æ­£åœ¨é€£æ¥ API...</span>`;
            
            try {
                aiClient = new GoogleGenAI({ apiKey: geminiApiKey }); 
                await aiClient.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: 'Hello.', 
                    config: { maxOutputTokens: 1 } 
                });
                
                keyStatusDiv.innerHTML = `<span style="color:green; font-weight:bold;">âœ… Key é©—è­‰æˆåŠŸï¼</span>`;
                isKeyValid = true;
                generateBtn.disabled = false; 
                
            } catch (error) {
                console.error("Key é©—è­‰å¤±æ•—:", error);
                let errorMsg = error.message.includes('401') ? "é‡‘é‘°ç„¡æ•ˆ (401 Unauthorized)ã€‚" : `é€£ç·šå¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯: ${error.message.substring(0, 50)}...`;
                keyStatusDiv.innerHTML = `<span style="color:red;">âŒ Key é©—è­‰å¤±æ•—ã€‚åŸå› : ${errorMsg}</span>`;
                isKeyValid = false;
                generateBtn.disabled = true; 
            } finally {
                setButtonState('validate-btn', false, 'é©—è­‰ Key');
            }
        }


        // å‡½å¼ï¼šç”Ÿæˆ Google åœ–ç‰‡æœå°‹é€£çµ
        function generateImageSearchUrl(location) {
            const encodedLocation = encodeURIComponent(location);
            return `https://www.google.com/search?tbm=isch&q=${encodedLocation}`;
        }
        
        // å‡½å¼ï¼šç”Ÿæˆæƒ…ç·’é¸æ“‡ä¸‹æ‹‰é¸å–®
        function generateMoodSelect(dayIndex) {
            let options = MOOD_OPTIONS.map(mood => 
                `<option value="${mood.value}">${mood.label}</option>`
            ).join('');
            
            return `
                <select class="day-mood-select" data-day-index="${dayIndex}">
                    <option value="" disabled selected>é¸æ“‡ä»Šæ—¥å¿ƒæƒ…</option>
                    ${options}
                </select>
            `;
        }
        
        // åœ°åœ–åµŒå…¥å‡½å¼
        function generateMapEmbedUrl(location) {
            const encodedLocation = encodeURIComponent(location);
            return `https://maps.google.com/maps?q=${encodedLocation}&output=embed&z=14&hl=zh-TW`; 
        }

        // ä¸»å‡½å¼ï¼šç”Ÿæˆè¡Œç¨‹
        async function generateItinerary() {
            const destination = document.getElementById('destination').value.trim();
            const duration = document.getElementById('duration').value.trim();
            const travelers = document.getElementById('travelers').value.trim();
            const budget = document.getElementById('budget').value;
            const transport = document.getElementById('transport').value;
            const moodTheme = document.getElementById('mood_theme').value.trim();
            const currentMood = document.getElementById('current_mood').value;
            const interests = document.getElementById('interests').value.trim();
            const outputDiv = document.getElementById('itinerary-output');
            const analyzeBtn = document.getElementById('analyze-mood-btn');
            
            if (!isKeyValid || !aiClient) {
                outputDiv.innerHTML = "<p style='color:red;'>è«‹å…ˆé©—è­‰æ‚¨çš„ Gemini API Keyã€‚</p>";
                return;
            }
            if (!destination || !duration || !travelers || !moodTheme) {
                outputDiv.innerHTML = "<p style='color:red;'>è«‹è¼¸å…¥æ—…éŠåœ°å€ã€å¤©æ•¸ã€äººæ•¸å’Œæ—…éŠä¸»é¡Œã€‚</p>";
                return;
            }

            setButtonState('generate-btn', true, 'ç”Ÿæˆä¸­...');
            analyzeBtn.style.display = 'none';
            document.getElementById('final-mood-summary').innerHTML = '';
            outputDiv.innerHTML = "<div class='loading'>æ­£åœ¨å‘¼å« AI è¦åŠƒè¡Œç¨‹ï¼Œè«‹ç¨å€™...</div>";

            try {
                applyMoodTheme(moodTheme);

                const prompt = `
                ä½ æ˜¯ä¸€ä½å°ˆæ³¨æ–¼ã€Œå€‹äººåŒ–æƒ…ç·’åƒ¹å€¼ã€çš„æ—…éŠè¦åŠƒå¸«ã€‚
                ä½¿ç”¨è€…ç¾åœ¨çš„å¿ƒæƒ…æ˜¯ï¼šã€Œ${currentMood}ã€ï¼Œè«‹åœ¨è¡Œç¨‹è¦åŠƒå’Œå°èªä¸­å¾®èª¿èªæ°£ä»¥é«”ç¾é—œæ‡·ã€‚
                è«‹åš´æ ¼éµå®ˆæä¾›çš„ JSON Schema æ ¼å¼è¼¸å‡ºã€‚

                --- æ—…éŠéœ€æ±‚ç´°ç¯€ ---
                1. æ—…éŠåœ°å€ï¼š${destination}
                2. æ—…éŠå¤©æ•¸ï¼š${duration} å¤©
                3. åŒè¡Œäººæ•¸ï¼š${travelers} äºº
                4. **æ—…éŠä¸»é¡Œ/æƒ…å¢ƒï¼š${moodTheme}**
                5. é¡å¤–éœ€æ±‚ï¼š${interests || 'ç„¡'}
                `;

                const response = await aiClient.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                    config: {
                        responseMimeType: "application/json",
                        responseSchema: ITINERARY_SCHEMA,
                        temperature: 0.85 
                    }
                });

                fullItineraryData = JSON.parse(response.text);
                const itineraryData = fullItineraryData.days;

                // æ¸²æŸ“ HTML
                let htmlContent = `<h2>âœˆï¸ ç‚ºæ‚¨è¦åŠƒçš„ ${destination} ${duration} å¤© (${moodTheme}) è¡Œç¨‹</h2>`;
                
                htmlContent += `<div id="ai-greeting">**AI æ—…ä¼´å°èªï¼š** ${fullItineraryData.greeting}</div>`;

                const analysis = fullItineraryData.mood_analysis;
                htmlContent += `
                    <div id="mood-analysis">
                        **è¡Œç¨‹æ°£æ°›åˆ†æ (æƒ…ç·’è‰²å½©æ¯”ä¾‹):**
                        <p>ğŸŒ¼ æ”¾é¬†ï¼š${analysis.relax || 'N/A'}</p>
                        <p>ğŸ’ æµªæ¼«ï¼š${analysis.romantic || 'N/A'}</p>
                        <p>ğŸ—ºï¸ æ¢ç´¢ï¼š${analysis.explore || 'N/A'}</p>
                    </div>
                `;

                let overallTotalCost = 0;

                itineraryData.forEach((dayPlan, dayIndex) => {
                    let totalCost = 0;
                    let dailyHtml = '';
                    
                    dayPlan.items.forEach(item => {
                        const costValue = parseInt(item.cost) || 0; 
                        totalCost += costValue;
                        overallTotalCost += costValue;
                        const mapLink = generateMapEmbedUrl(item.location); 
                        const imageLink = generateImageSearchUrl(item.location); 

                        dailyHtml += `
                            <tr>
                                <td class="time-col">${item.time}</td>
                                <td class="duration-col">
                                    æ´»å‹•: ${item.duration_activity}<br>
                                    <span style="color:#d32f2f;">äº¤é€š: ${item.duration_travel}</span>
                                </td>
                                <td class="item-col">
                                    <strong>[${item.type}]</strong> ${item.description}<br>
                                    <div class="mood-note">âœ¨ **æƒ…æ„Ÿå‚™è¨»ï¼š** ${item.mood_note}</div>
                                    <div class="note-intro">**ä»‹ç´¹ï¼š** ${item.intro}</div>
                                    <small>åœ°é»ï¼š${item.location}</small>
                                    
                                    <a class="image-btn" 
                                        href="${imageLink}"
                                        target="_blank"
                                        title="é»æ“ŠæŸ¥çœ‹è©²åœ°é»çš„åœ–ç‰‡">
                                        ğŸ“¸ åœ–ç‰‡åƒè€ƒ
                                    </a>
                                </td>
                                <td class="transport-col">${item.transport}</td>
                                <td class="cost-col">$${costValue}</td>
                            </tr>
                            <tr>
                                <td colspan="5" style="padding-top: 0;">
                                    <div class="map-container">
                                        <iframe class="map-iframe" 
                                                    loading="lazy"
                                                    src="${mapLink}" 
                                                    allowfullscreen>
                                        </iframe>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });


                    htmlContent += `
                        <div class="day-plan">
                            <h3 id="day-title-${dayIndex}">${dayPlan.day} - ${dayPlan.date}</h3>
                            <div class="table-wrapper">
                                <table class="itinerary-table">
                                    <thead>
                                        <tr>
                                            <th class="time-col">é–‹å§‹æ™‚é–“</th>
                                            <th class="duration-col">é ä¼°æ™‚é•·</th>
                                            <th class="item-col">é …ç›® (é¡å‹/æƒ…ç·’)</th>
                                            <th class="transport-col">äº¤é€š</th>
                                            <th class="cost-col">é ä¼°é‡‘é¡ (TWD)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${dailyHtml}
                                    </tbody>
                                </table>
                            </div>
                            <div class="summary">
                                ç•¶æ—¥ç¸½é ä¼°èŠ±è²»ï¼š$${totalCost} TWD
                            </div>
                            
                            <div class="feedback-container" data-day-index="${dayIndex}">
                                <div>
                                    <label for="mood-select-${dayIndex}">ä»Šæ—¥æ„Ÿå—ï¼š</label>
                                    ${generateMoodSelect(dayIndex)}
                                </div>
                                <div>
                                    <label for="sentence-input-${dayIndex}">ä¸€å¥è©±è¨˜éŒ„ï¼š</label>
                                    <input type="text" id="sentence-input-${dayIndex}" placeholder="ä¾‹å¦‚ï¼šåœ¨å±…é…’å±‹çš„ç†±é¬§æ°£æ°›è®“æˆ‘æ„Ÿåˆ°å¾ˆæ»¿è¶³" class="day-sentence-input" data-day-index="${dayIndex}">
                                </div>
                            </div>
                        </div>
                    `;
                });

                htmlContent += `<h2 class="final-cost">ğŸ’– ç¸½é ä¼°èŠ±è²» (ä¾› ${travelers} äººåƒè€ƒ)ï¼š$${overallTotalCost} TWD</h2>`;

                outputDiv.innerHTML = htmlContent;
                analyzeBtn.style.display = 'block'; // é¡¯ç¤ºæœ€çµ‚åˆ†ææŒ‰éˆ•

            } catch (error) {
                console.error("ç”Ÿæˆè¡Œç¨‹æ™‚ç™¼ç”ŸéŒ¯èª¤:", error);
                
                let errorMsg = error.message.includes('Unexpected token') || error.message.includes('JSON') ?
                    'è¡Œç¨‹ç”Ÿæˆå¤±æ•—ã€‚AI å›å‚³çš„ JSON æ ¼å¼ä¸æ­£ç¢ºã€‚è«‹å˜—è©¦ç°¡åŒ–æ‚¨çš„éœ€æ±‚æˆ–æª¢æŸ¥ Key ç‹€æ…‹ã€‚' :
                    `è¡Œç¨‹ç”Ÿæˆå¤±æ•—ã€‚éŒ¯èª¤è¨Šæ¯ï¼š${error.message}`;
                
                outputDiv.innerHTML = `<p style='color:red;'>${errorMsg}</p>`;
            } finally {
                setButtonState('generate-btn', false, 'ğŸ’– ç‚ºæˆ‘ç”Ÿæˆå……æ»¿æƒ…ç·’åƒ¹å€¼çš„å°ˆå±¬è¡Œç¨‹');
            }
        }


        /**
         * æœ€çµ‚ AI åˆ†æåŠŸèƒ½
         */
        async function analyzeFinalMood() {
            const analyzeBtn = document.getElementById('analyze-mood-btn');
            const summaryDiv = document.getElementById('final-mood-summary');
            
            if (!fullItineraryData) {
                summaryDiv.innerHTML = '<p style="color:red;">è«‹å…ˆç”Ÿæˆè¡Œç¨‹ï¼</p>';
                return;
            }

            setButtonState('analyze-mood-btn', true, 'AI æ­£åœ¨åˆ†ææ‚¨çš„æƒ…ç·’è»Œè·¡...');
            summaryDiv.innerHTML = '<div class="loading">æ­£åœ¨æ•´åˆæ‚¨çš„æ¯æ—¥åé¥‹ï¼Œè«‹ç¨å€™...</div>';

            // æ”¶é›†æ‰€æœ‰ä½¿ç”¨è€…çš„åé¥‹
            const userFeedbacks = [];
            const dayPlans = fullItineraryData.days;
            
            dayPlans.forEach((dayPlan, index) => {
                const moodSelect = document.querySelector(`.day-mood-select[data-day-index="${index}"]`);
                const sentenceInput = document.querySelector(`.day-sentence-input[data-day-index="${index}"]`);
                const dayTitle = document.getElementById(`day-title-${index}`).textContent;
                
                const selectedMood = moodSelect ? moodSelect.value : 'æœªé¸æ“‡';
                const inputSentence = sentenceInput ? sentenceInput.value.trim() : 'ç„¡è¨˜éŒ„';

                userFeedbacks.push({
                    day: dayTitle,
                    mood: selectedMood,
                    sentence: inputSentence,
                    ai_mood_note: dayPlan.items.map(item => item.mood_note).join('; ')
                });
            });

            // æº–å‚™ AI Prompt
            const moodTheme = document.getElementById('mood_theme').value.trim();
            const travelers = document.getElementById('travelers').value.trim();

            const prompt = `
            ä½ æ˜¯ä¸€ä½æ·±åº¦æƒ…ç·’æ—…éŠåˆ†æå¸«ã€‚æˆ‘ï¼ˆå€‘ï¼‰çš„æ—…éŠä¸»é¡Œæ˜¯ã€Œ${moodTheme}ã€ï¼ŒåŒè¡Œäººæ•¸ç‚º ${travelers} äººã€‚
            ä»¥ä¸‹æ˜¯è¡Œç¨‹ä¸­çš„ AI é è¨­æƒ…ç·’å‚™è¨»ï¼ˆai_mood_noteï¼‰ä»¥åŠæˆ‘ï¼ˆå€‘ï¼‰çš„æ¯æ—¥æƒ…ç·’åé¥‹ï¼ˆmood å’Œ sentenceï¼‰ã€‚
            
            --- æ¯æ—¥æƒ…ç·’ç´€éŒ„ ---
            ${userFeedbacks.map(f => 
                `[${f.day}]\n  - æˆ‘çš„æ„Ÿå—ï¼š${f.mood}ã€‚æˆ‘çš„è¨˜éŒ„ï¼š"${f.sentence}"ã€‚\n  - AI é è¨­ï¼š${f.ai_mood_note}`
            ).join('\n')}
            ---
            
            è«‹æ ¹æ“šé€™äº›ç´€éŒ„ï¼Œæä¾›ä¸€æ®µæ·±åº¦æƒ…ç·’åƒ¹å€¼å›é¥‹ï¼š
            1. **æ•´é«”æƒ…ç·’è»Œè·¡åˆ†æï¼š** ç°¡è¦æè¿°æˆ‘çš„æƒ…ç·’å¦‚ä½•éš¨è‘—æ—…ç¨‹ç™¼å±•ã€‚
            2. **é æœŸèˆ‡å¯¦éš›å·®ç•°ï¼š** åˆ†æ AI é è¨­çš„æƒ…ç·’ï¼ˆai_mood_noteï¼‰å’Œæˆ‘å¯¦éš›æ„Ÿå—ï¼ˆmood/sentenceï¼‰çš„ç•°åŒã€‚
            3. **çµè«–æƒ…ç·’åƒ¹å€¼ï¼š** ç¸½çµé€™è¶Ÿæ—…ç¨‹å¸¶çµ¦æˆ‘çš„æœ€é‡è¦æƒ…ç·’åƒ¹å€¼ï¼ˆä¾‹å¦‚ï¼šæ‰¾åˆ°äº†å¹³éœã€æ„›æƒ…å¾—åˆ°å‡è¯ã€æˆ°å‹äº†ç–²æ†Šç­‰ï¼‰ï¼Œä¸¦ç”¨ä¸€å¥æº«æš–çš„è©±ä½œç‚ºçµæŸã€‚
            
            è«‹ä½¿ç”¨æ¸…æ™°çš„æ®µè½ï¼Œä¸¦é¿å…ä½¿ç”¨ JSON æ ¼å¼ã€‚
            `;

            try {
                const response = await aiClient.models.generateContent({
                    model: 'gemini-2.5-flash',
                    contents: prompt,
                    config: { temperature: 0.7 }
                });

                summaryDiv.innerHTML = `
                    <h3>ğŸ’– æ‚¨çš„æ—…ç¨‹æƒ…ç·’ç¸½çµï¼š</h3>
                    <div style="white-space: pre-wrap;">${response.text.trim()}</div>
                `;

            } catch (error) {
                console.error("æœ€çµ‚æƒ…ç·’åˆ†æå¤±æ•—:", error);
                summaryDiv.innerHTML = '<p style="color:red;">æœ€çµ‚æƒ…ç·’åˆ†æå¤±æ•—ã€‚è«‹æª¢æŸ¥ Key ç‹€æ…‹æˆ–ç¶²è·¯é€£ç·šã€‚</p>';
            } finally {
                setButtonState('analyze-mood-btn', false, 'ğŸ’¡ é»æ“Šï¼šç¸½çµæˆ‘çš„æ—…ç¨‹æƒ…ç·’èˆ‡åƒ¹å€¼å›é¥‹');
            }
        }


        // äº‹ä»¶ç›£è½å™¨
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('validate-btn').addEventListener('click', validateKey);
            document.getElementById('generate-btn').addEventListener('click', generateItinerary);
            document.getElementById('analyze-mood-btn').addEventListener('click', analyzeFinalMood);
            
            // ç›£è½ Key è¼¸å…¥æ¡†ï¼Œä¸€æ—¦ä¿®æ”¹å°±é‡ç½®é©—è­‰ç‹€æ…‹
            document.getElementById('key-input').addEventListener('input', () => {
                isKeyValid = false;
                document.getElementById('generate-btn').disabled = true;
                document.getElementById('key-status').innerHTML = '';
                document.getElementById('itinerary-output').innerHTML = '<p>è«‹é‡æ–°é©—è­‰æ‚¨çš„ Keyã€‚</p>';
                document.getElementById('analyze-mood-btn').style.display = 'none';
                document.getElementById('final-mood-summary').innerHTML = '';
                document.getElementById('mood-audio').pause();
            });
            
            // è®“ä½¿ç”¨è€…è¼¸å…¥æ¬„ä½ä¸€ä¿®æ”¹å°±è¦æ±‚é‡æ–°ç”Ÿæˆ
             document.querySelectorAll('#input-fields input, #input-fields select, #mood_theme, #interests').forEach(input => {
                input.addEventListener('input', () => {
                    document.getElementById('itinerary-output').innerHTML = '<p>è«‹é»æ“ŠæŒ‰éˆ•ä¾†é‡æ–°è¦åŠƒã€‚</p>';
                    document.getElementById('analyze-mood-btn').style.display = 'none';
                    document.getElementById('final-mood-summary').innerHTML = '';
                });
            });

            // åˆå§‹è¼‰å…¥æ™‚ï¼Œæ ¹æ“šé è¨­ä¸»é¡Œæ‡‰ç”¨é¡è‰²å’ŒéŸ³æ•ˆ
            applyMoodTheme(document.getElementById('mood_theme').value);
        });
    </script>
</body>
</html>
